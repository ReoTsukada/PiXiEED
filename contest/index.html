<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>PiXiEED ドットギャラリー</title>
  <link rel="icon" type="image/png" href="../character-dots/mao1.png"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Fredoka:wght@600&display=swap" rel="stylesheet">
  <style>
    :root{ color-scheme: dark; }
    *{
      box-sizing:border-box;
      user-select:none;
      -webkit-user-select:none;
      -ms-user-select:none;
    }
    body{
      margin:0;
      font-family:'Fredoka', 'DotGothic16', system-ui, sans-serif;
      background:radial-gradient(circle at 20% 20%, rgba(59,130,246,0.22), rgba(15,23,42,1)),
                 radial-gradient(circle at 80% 0%, rgba(236,72,153,0.18), rgba(15,23,42,1)),
                 #0b1224;
      color:#e5e7eb;
      min-height:100vh;
      padding:28px 14px 60px;
      display:flex;
      justify-content:center;
    }
    .page{ width:100%; max-width:640px; display:grid; gap:14px; position:relative; }
    header{
      position:sticky;
      top:0;
      z-index:60;
      background:rgba(11,18,36,0.94);
      backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(255,255,255,0.08);
      margin:-28px -14px 12px;
      padding:10px 14px;
    }
    .header-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:0.01em;
    }
    .brand-icon{
      width:34px;
      height:34px;
      border-radius:10px;
      background:rgba(255,255,255,0.12);
      padding:4px;
      border:1px solid rgba(255,255,255,0.2);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .brand-icon img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-title{ margin:0; font-size:16px; color:#f9fafb; }
    .brand-sub{ margin:0; font-size:12px; color:#9ca3af; }
    .header-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }
    h1{ margin:0; font-size:22px; letter-spacing:0.02em; color:#f9fafb; }
    .subtitle{ margin:0; color:#cbd5e1; font-size:12px; }
    .card{
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:12px;
      padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,0.3);
    }
    .grid{ display:grid; gap:14px; grid-template-columns:1fr; }
    .prompt{ display:flex; flex-direction:column; gap:6px; }
    .prompt-title{ margin:0; font-size:15px; color:#f9fafb; }
    .prompt-text{
      padding:10px;
      border-radius:10px;
      background:rgba(59,130,246,0.18);
      border:1px solid rgba(59,130,246,0.35);
      color:#e0f2fe;
      font-family:'DotGothic16', monospace;
    }
    .button{
      appearance:none;
      border:0;
      border-radius:10px;
      padding:10px 14px;
      font:700 14px/1.2 'Fredoka', system-ui, sans-serif;
      cursor:pointer;
      color:#ffffff;
      background:linear-gradient(135deg, #ff719a, #ff9f43);
      box-shadow:0 4px 0 #e35c82, 0 8px 16px rgba(255,113,154,0.35);
      transition:transform 0.1s ease, filter 0.1s ease;
    }
    .button:hover,
    .button:focus-visible{ transform:translateY(-1px); filter:brightness(1.05); }
    form{ display:flex; flex-direction:column; gap:10px; }
    .field{ display:flex; flex-direction:column; gap:4px; }
    label{ font-weight:700; color:#e5e7eb; }
    input[type="text"], input[type="file"]{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.35);
      color:#f9fafb;
      padding:10px 12px;
      font-size:14px;
      font-family:'DotGothic16', monospace;
    }
    .helper{ color:#cbd5e1; font-size:12px; margin:0; }
    .status{ min-height:20px; color:#fef3c7; font-size:12px; margin:4px 0 0; }
    .gallery{
      display:grid;
      gap:12px;
      grid-template-columns:repeat(3, 1fr);
    }
    .tabs{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .tab-btn{
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(255,255,255,0.06);
      color:#e5e7eb;
      border-radius:10px;
      padding:8px 12px;
      font-weight:700;
      cursor:pointer;
    }
    .tab-btn.is-active{
      background:linear-gradient(135deg,#ff719a,#ff9f43);
      border-color:transparent;
      color:#0b1224;
    }
    .sort-tabs{
      display:flex;
      gap:6px;
      align-items:center;
      margin-left:auto;
      flex-wrap:wrap;
    }
    .sort-btn{
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.05);
      color:#e5e7eb;
      border-radius:8px;
      padding:6px 10px;
      font-weight:700;
      cursor:pointer;
    }
    .sort-btn.is-active{
      background:rgba(251,191,36,0.22);
      border-color:rgba(251,191,36,0.6);
      color:#0b1224;
    }
    .entry-card{
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:0 0 10px 10px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow:0 8px 24px rgba(0,0,0,0.26);
      position:relative;
      text-decoration:none;
      color:inherit;
    }
    .entry-imgwrap{
      padding:0;
      background:transparent;
      display:block;
      position:relative;
    }
    .entry-imgwrap img{
      width:100%;
      height:100%;
      object-fit:cover;
      image-rendering:pixelated;
      border:0;
      background:transparent;
      position:relative;
      z-index:1;
    }
    .heart-btn{
      position:absolute;
      right:4px;
      bottom:4px;
      border:none;
      background:transparent;
      padding:0;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      z-index:2;
    }
    .heart-btn img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }
    .heart-btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    .entry-meta{ padding:10px; display:flex; flex-direction:column; gap:6px; }
    .entry-meta__top{ display:flex; align-items:center; justify-content:space-between; gap:6px; }
    .entry-title{ font-weight:800; color:#f9fafb; }
    .entry-like{ color:#fbbf24; font-weight:800; }
    .entry-author{ margin:0; color:#cbd5e1; font-size:12px; }
    .entry-info{ margin:0; color:#94a3b8; font-size:11px; }
    .like-btn{
      border:1px solid rgba(251,191,36,0.5);
      background:rgba(251,191,36,0.12);
      color:#fbbf24;
      border-radius:8px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:700;
      font-family:'DotGothic16', monospace;
    }
    .like-btn:disabled{ opacity:0.5; cursor:not-allowed; }
    .empty{ color:#cbd5e1; text-align:center; margin:8px 0 0; font-family:'DotGothic16', monospace; }
    .feed-subtitle{
      margin:0;
      color:#9ca3af;
      font-size:12px;
    }
    .top-bar{
      display:flex;
      flex-direction:column;
      gap:4px;
      width:100%;
    }
    .auth-chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.16);
      color:#fff;
      cursor:pointer;
      font-weight:700;
    }
    .auth-chip__status{
      font-size:12px;
      color:#cbd5e1;
    }
    .auth-panel{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.65);
      backdrop-filter:blur(4px);
      padding:16px;
      z-index:70;
    }
    .auth-panel.is-open{ display:flex; }
    .auth-card{
      width:100%;
      max-width:420px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(255,255,255,0.14);
      border-radius:16px;
      padding:16px;
      box-shadow:0 18px 40px rgba(0,0,0,0.45);
      display:grid;
      gap:12px;
    }
    .auth-input{
      min-width:0;
      width:100%;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.05);
      color:#fff;
      padding:10px 12px;
      font-size:14px;
    }
    .auth-btn{
      border:1px solid rgba(255,255,255,0.2);
      background:linear-gradient(135deg,#4f46e5,#7c3aed);
      color:#fff;
      border-radius:12px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      text-align:center;
    }
    .auth-btn.logout{
      background:rgba(255,255,255,0.08);
      border-color:rgba(255,255,255,0.2);
    }
    .auth-status{
      font-size:12px;
      color:#cbd5e1;
      min-height:16px;
    }
    .profile-block{
      display:grid;
      gap:10px;
      padding:10px;
      border-radius:12px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.08);
    }
    .avatar-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(64px,1fr));
      gap:10px;
    }
    .avatar-option{
      width:100%;
      aspect-ratio:1;
      border-radius:12px;
      border:2px solid transparent;
      background:rgba(255,255,255,0.08);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:800;
      transition:border-color 0.15s ease, transform 0.1s ease;
    }
    .avatar-option.is-active{
      border-color:#7c3aed;
      transform:translateY(-1px);
    }
    .fab{
      position:fixed;
      right:18px;
      bottom:18px;
      width:56px;
      height:56px;
      border-radius:50%;
      background:linear-gradient(135deg, #ff719a, #ff9f43);
      color:#fff;
      font:800 28px/1 'Fredoka', system-ui, sans-serif;
      border:0;
      box-shadow:0 8px 20px rgba(0,0,0,0.25);
      cursor:pointer;
      z-index:60;
    }
    .fab:focus-visible{ outline:3px solid rgba(255,255,255,0.4); }
    .post-panel{
      position:fixed;
      inset:0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      background:rgba(0,0,0,0.65);
      backdrop-filter:blur(4px);
      padding:16px;
      z-index:50;
    }
    .post-panel.is-open{ display:flex; }
    .post-card{
      width:100%;
      max-width:560px;
      background:rgba(15,23,42,0.92);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:16px;
      padding:14px;
      box-shadow:0 12px 40px rgba(0,0,0,0.4);
    }
    .post-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
    }
    .post-title{ margin:0; font-size:16px; color:#f9fafb; }
    .close-btn{
      border:1px solid rgba(255,255,255,0.2);
      background:rgba(255,255,255,0.08);
      color:#fff;
      border-radius:8px;
      padding:6px 10px;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="page">
    <header aria-label="top-nav">
      <div class="header-inner">
        <button class="brand" id="openProfilePanel" type="button" style="background:none;border:0;cursor:pointer;padding:0;">
          <span class="brand-icon" id="brandAvatar">
            <img src="../character-dots/mao1.png" alt="logo">
          </span>
          <div class="brand-text">
            <p class="brand-title">PiXiEED</p>
            <p class="brand-sub">Dot Gallery</p>
          </div>
        </button>
        <div class="header-actions"></div>
      </div>
    </header>
    <section class="card">
      <div class="top-bar">
        <h1>ドットギャラリー</h1>
        <p class="subtitle">みんなのドットを眺めよう。512x512以内 / 256色以内のPNGを投稿もできます。</p>
        <p class="feed-subtitle">最新→いいね順で並びます</p>
      </div>
    </section>
    <section class="card">
      <div class="tabs">
        <div id="filterTabs" style="display:flex; gap:8px;">
          <button class="tab-btn is-active" data-filter="all" type="button">すべて</button>
          <button class="tab-btn" data-filter="timed10" type="button">10m</button>
          <button class="tab-btn" data-filter="px32" type="button">32px</button>
        </div>
        <div class="sort-tabs" id="sortTabs">
          <span class="helper" style="margin-right:4px;">並び替え:</span>
          <button class="sort-btn is-active" data-sort="new" type="button">新着</button>
          <button class="sort-btn" data-sort="popular" type="button">人気</button>
        </div>
      </div>
      <div id="contestGallery" class="gallery"></div>
    </section>

    <div class="grid">
    </div>
  </div>
  <button class="fab" id="openPostPanel">＋</button>
  <div class="post-panel" id="postPanel" aria-hidden="true">
    <div class="post-card">
      <div class="post-header">
        <h3 class="post-title">投稿する</h3>
        <button class="close-btn" type="button" id="closePostPanel">閉じる</button>
      </div>
      <form id="contestForm">
        <div class="field">
          <label for="name">名前</label>
          <input id="name" name="name" type="text" placeholder="ハンドルネーム"/>
        </div>
        <div class="field">
          <label for="title">作品名</label>
          <input id="title" name="title" type="text" placeholder="無題"/>
        </div>
        <div class="field">
          <label for="contestFile">PNG / GIF</label>
          <input id="contestFile" name="contestFile" type="file" accept="image/png,image/gif"/>
          <p class="helper">PNG または GIF（サムネは1フレーム表示） / 512x512以内 / 256色以内</p>
        </div>
        <button class="button" type="submit">投稿する</button>
        <p class="status" id="contestStatus"></p>
      </form>
    </div>
  </div>
  <div class="auth-panel" id="authPanel" aria-hidden="true">
    <div class="auth-card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h3 style="margin:0;font-size:16px;color:#f9fafb;">プロフィール</h3>
        <button class="close-btn" type="button" id="closeAuthPanel">閉じる</button>
      </div>
      <div class="profile-block">
        <label style="display:flex; flex-direction:column; gap:6px;">
          <span style="font-weight:700; color:#e5e7eb;">ニックネーム</span>
          <input class="auth-input" id="profileNickname" type="text" placeholder="なまえ" maxlength="32">
        </label>
        <div>
          <p class="helper" style="margin:0 0 6px;">アイコン</p>
          <div class="avatar-grid" id="avatarGrid"></div>
        </div>
        <button class="auth-btn" id="saveProfile" type="button">プロフィールを保存</button>
      </div>
      <div class="profile-block">
        <p class="helper" style="margin:0 0 6px;">アカウント紐付け</p>
        <p class="helper" id="linkedEmail" style="margin:0 0 6px; display:none;"></p>
        <div id="authInputs">
          <input class="auth-input" id="authEmail" type="email" placeholder="メールアドレス" autocomplete="email">
          <input class="auth-input" id="authPasscode" type="password" placeholder="パスコード（6〜20文字）" autocomplete="current-password">
        </div>
        <button class="auth-btn" id="authBtn" type="button">メール＋パスコードでログイン</button>
        <button class="auth-btn logout" id="logoutBtn" type="button" style="display:none;">ログアウト</button>
      </div>
      <p class="auth-status" id="authStatus"></p>
    </div>
  </div>
  <script type="module">
    // インライン版：file:// でも必ずダミー表示。Supabaseが使えない場合もプレース表示。
    const SUPABASE_URL = 'https://kyyiuakrqomzlikfaire.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_gnc61sD2hZvGHhEW8bQMoA_lrL07SN4';
    const FORM_ID = 'contestForm';
    const FILE_INPUT_ID = 'contestFile';
    const STATUS_ID = 'contestStatus';
    const GALLERY_ID = 'contestGallery';
    const MAX_SIZE = 512;
    const MAX_COLORS = 256;
    let supportsClientId = true;
    let supabaseUser = null;
    let supabaseSession = null;
    let migrationDone = false;

    let clientId = null;
    let likedEntries = new Set();
    let currentFilter = 'all';
    let currentSort = 'new';
    let cachedEntries = [];
    let supabase = null;
    const SAMPLE_COLORS = ['#7dd3fc','#f472b6','#facc15','#34d399','#c084fc','#60a5fa','#f59e0b','#a3e635','#f43f5e','#38bdf8'];
    const PLACEHOLDERS = Array.from({ length: 10 }, (_, i) => ({
      id: 100000 + i,
      title: `サンプル${i + 1}`,
      name: `サンプル${i + 1}`,
      width: 512,
      height: 512,
      colors: 256,
      image_base64: makePlaceholder(SAMPLE_COLORS[i % SAMPLE_COLORS.length]),
      submitted_at: new Date().toISOString(),
      likeCount: 0,
      mode: i % 2 === 0 ? 'timed10' : 'free',
      color: SAMPLE_COLORS[i % SAMPLE_COLORS.length]
    }));

    const NFAV_SRC = '../pixiedraw/assets/NFav.png';
    const FAV_SRC = '../pixiedraw/assets/Fav.png';

    function $(id){ return document.getElementById(id); }

    const AVATARS = [
      { id:'pink', label:'Pink', style:'background:linear-gradient(135deg,#f472b6,#fb7185);' },
      { id:'blue', label:'Blue', style:'background:linear-gradient(135deg,#60a5fa,#22d3ee);' },
      { id:'green', label:'Green', style:'background:linear-gradient(135deg,#34d399,#a3e635);' },
      { id:'gold', label:'Gold', style:'background:linear-gradient(135deg,#fbbf24,#f59e0b);' },
      { id:'violet', label:'Violet', style:'background:linear-gradient(135deg,#c084fc,#7c3aed);' },
      { id:'gray', label:'Gray', style:'background:linear-gradient(135deg,#94a3b8,#475569);' }
    ];

    function loadNickname(){
      try{
        return localStorage.getItem('pixieed_nickname') || '';
      }catch(_){
        return '';
      }
    }

    function saveNickname(name){
      try{
        localStorage.setItem('pixieed_nickname', name);
      }catch(_){}
    }

    function loadAvatar(){
      try{
        return localStorage.getItem('pixieed_avatar') || 'pink';
      }catch(_){
        return 'pink';
      }
    }

    function saveAvatar(id){
      try{
        localStorage.setItem('pixieed_avatar', id);
      }catch(_){}
    }

    function ensureClientId(){
      const KEY = 'pixieed_client_id';
      try{
        const saved = localStorage.getItem(KEY) || window.PIXIEED_CLIENT_ID;
        if(saved){
          clientId = saved;
          if(!localStorage.getItem(KEY)) localStorage.setItem(KEY, saved);
          return;
        }
        const id = crypto.randomUUID ? crypto.randomUUID() : `guest-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;
        localStorage.setItem(KEY, id);
        clientId = id;
      }catch(_){
        clientId = `guest-${Math.random().toString(36).slice(2,8)}`;
      }
    }

    function setStatus(msg){
      const el = $(STATUS_ID);
      if(el) el.textContent = msg || '';
    }

    function setAuthStatus(msg){
      const el = document.getElementById('authStatus');
      if(el) el.textContent = msg || '';
    }

    function applyAvatarToBrand(){
      const brand = document.getElementById('brandAvatar');
      const avatarId = loadAvatar();
      const found = AVATARS.find(a => a.id === avatarId);
      if(brand){
        if(found){
          brand.style = `${found.style} border:1px solid rgba(255,255,255,0.25);`;
          brand.innerHTML = '';
        }else{
          brand.style = '';
          brand.innerHTML = `<img src="../character-dots/mao1.png" alt="logo">`;
        }
      }
    }

    function renderAvatarChoices(){
      const grid = document.getElementById('avatarGrid');
      if(!grid) return;
      grid.innerHTML = '';
      const current = loadAvatar();
      AVATARS.forEach(a => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `avatar-option${current === a.id ? ' is-active' : ''}`;
        btn.style = a.style;
        btn.textContent = '';
        btn.addEventListener('click', () => {
          saveAvatar(a.id);
          renderAvatarChoices();
          applyAvatarToBrand();
        });
        grid.appendChild(btn);
      });
    }

    function setupTabs(){
      const filterTabs = document.getElementById('filterTabs');
      const sortTabs = document.getElementById('sortTabs');
      if(filterTabs){
        filterTabs.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            currentFilter = btn.dataset.filter || 'all';
            filterTabs.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('is-active', b === btn));
            renderEntries(applyFilterAndSort(cachedEntries));
          });
        });
      }
      if(sortTabs){
        sortTabs.querySelectorAll('.sort-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            currentSort = btn.dataset.sort || 'new';
            sortTabs.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('is-active', b === btn));
            renderEntries(applyFilterAndSort(cachedEntries));
          });
        });
      }
    }

    async function fileToImageInfo(file){
      const type = (file.type || '').toLowerCase();
      if(type !== 'image/png' && type !== 'image/gif'){
        throw new Error('PNGまたはGIFのみ投稿できます');
      }
      const img = await createImageBitmap(file);
      const { width, height } = img;
      if(width > MAX_SIZE || height > MAX_SIZE){
        throw new Error(`画像サイズは${MAX_SIZE}x${MAX_SIZE}以内にしてください`);
      }
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);

      // 色数チェック（原画ベース）
      const baseData = ctx.getImageData(0,0,width,height).data;
      const colors = new Set();
      for(let i=0;i<baseData.length;i+=4){
        colors.add(`${baseData[i]}-${baseData[i+1]}-${baseData[i+2]}-${baseData[i+3]}`);
        if(colors.size > MAX_COLORS){
          throw new Error(`色数は${MAX_COLORS}色以内にしてください`);
        }
      }

      // 透かしを薄く付与
      drawWatermark(ctx, width, height);
      // 不可視ハッシュをLSBに埋め込み
      await embedInvisibleHash(canvas);

      // GIFもPNGサムネに変換して保存
      const dataUrl = canvas.toDataURL('image/png');
      return { width, height, colors: colors.size, dataUrl };
    }

    function drawWatermark(ctx, width, height){
      ctx.save();
      const size = Math.max(12, Math.round(Math.min(width, height) * 0.08));
      ctx.font = `${size}px 'DotGothic16', sans-serif`;
      ctx.fillStyle = 'rgba(255,255,255,0.12)';
      ctx.textBaseline = 'bottom';
      ctx.textAlign = 'right';
      ctx.filter = 'drop-shadow(0 0 6px rgba(0,0,0,0.45))';
      ctx.fillText('PiXiEED', width - 8, height - 6);
      ctx.restore();
    }

    async function embedInvisibleHash(canvas){
      const ctx = canvas.getContext('2d');
      const { width, height } = canvas;
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;
      const hashBytes = await createHashBytes(`${clientId || 'guest'}-${Date.now()}-${Math.random()}`);
      const bitsNeeded = hashBytes.length * 8;
      // 透過ピクセルには書き込まない（透過面で白い点が出るのを防ぐ）
      const opaquePixels = [];
      for(let p=0; p<data.length/4; p++){
        const a = data[p*4 + 3];
        if(a >= 200) opaquePixels.push(p);
      }
      if(!opaquePixels.length) return;
      let bitIndex = 0;
      for(let i=0; i<bitsNeeded && i<opaquePixels.length; i++){
        const byte = hashBytes[Math.floor(bitIndex / 8)];
        const bit = (byte >> (bitIndex % 8)) & 1;
        const pix = opaquePixels[opaquePixels.length - 1 - i]; // 末尾側から
        const dataIndex = pix * 4 + 3; // alpha
        data[dataIndex] = (data[dataIndex] & 0xFE) | bit;
        bitIndex++;
      }
      ctx.putImageData(imageData, 0, 0);
    }

    async function createHashBytes(text){
      const enc = new TextEncoder().encode(text);
      try{
        const buf = await crypto.subtle.digest('SHA-256', enc);
        return new Uint8Array(buf).slice(0, 16); // 128bit
      }catch(_){
        // Fallback: simple hash
        let h = 0;
        for(const b of enc){ h = (h * 31 + b) >>> 0; }
        const arr = new Uint8Array(16);
        for(let i=0;i<16;i++){
          h = (h * 1664525 + 1013904223) >>> 0;
          arr[i] = h & 0xFF;
        }
        return arr;
      }
    }

    async function handleSubmit(e){
      e.preventDefault();
      const form = e.currentTarget;
      const name = form.name.value.trim() || loadNickname() || '名無し';
      const title = form.title.value.trim() || '無題';
      const file = form[FILE_INPUT_ID]?.files?.[0];
      if(!file){
        setStatus('画像ファイルを選択してください');
        return;
      }
      saveNickname(name);
      setStatus('画像を確認しています...');
      let imageInfo;
      try{
        imageInfo = await fileToImageInfo(file);
      }catch(err){
        setStatus(err.message || '画像の解析に失敗しました');
        return;
      }
      if(!supabase){
        setStatus('オンライン投稿は無効です（プレース表示のみ）');
        return;
      }
      setStatus('投稿しています...');
      try{
        const payload = {
          name,
          title,
          prompt: '自由投稿',
          mode: 'free',
          started_at: null,
          submitted_at: new Date().toISOString(),
          width: imageInfo.width,
          height: imageInfo.height,
          colors: imageInfo.colors,
          image_base64: imageInfo.dataUrl
        };
        if(supabaseUser?.id){
          payload.user_id = supabaseUser.id;
        }
        if(supportsClientId){
          payload.client_id = clientId;
        }
        let res = await supabase.from('contest_entries').insert(payload);
        if(res.error && supportsClientId && String(res.error.message || '').includes('client_id')){
          // client_id カラムが無い環境用フォールバック
          supportsClientId = false;
          delete payload.client_id;
          res = await supabase.from('contest_entries').insert(payload);
        }
        if(res.error){
          throw res.error;
        }
        form.reset();
        setStatus('投稿しました！');
      }catch(err){
        setStatus('投稿に失敗しました');
        console.error(err);
      }
      await fetchAndRender();
    }

    function renderEntries(entries){
      const gallery = $(GALLERY_ID);
      if(!gallery) return;
      if(!entries.length){
        gallery.innerHTML = '<p class="empty">まだ投稿がありません。</p>';
        return;
      }
      gallery.innerHTML = '';
      entries.forEach(entry => {
        const item = document.createElement('a');
        item.className = 'entry-card';
        item.href = `view.html?id=${entry.id}`;
        item.innerHTML = `
          <div class="entry-imgwrap">
            <img src="${entry.image_base64}" alt="${entry.title}">
            <button class="heart-btn" data-id="${entry.id}" aria-label="いいね">
              <img src="${likedEntries.has(entry.id) ? FAV_SRC : NFAV_SRC}" alt="like icon">
            </button>
          </div>
          <div class="entry-meta">
            <div class="entry-meta__top">
              <span class="entry-title">${escapeHtml(entry.title || '無題')}</span>
              <span class="entry-like">${entry.likeCount || 0}</span>
            </div>
            <p class="entry-author">by ${escapeHtml(entry.name || '名無し')}</p>
          </div>
        `;
        gallery.appendChild(item);
      });
      gallery.querySelectorAll('.heart-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          likeEntry(Number(btn.dataset.id));
        });
      });
    }

    async function fetchAndRender(){
      ensureClientId();
      setStatus('読み込み中...');
      let entries = [];
      let likes = [];
      let networkError = false;
      if(supabase){
        try{
          const res = await supabase
            .from('contest_entries')
            .select('id,name,title,prompt,mode,submitted_at,width,height,colors,image_base64')
            .order('submitted_at', { ascending:false })
            .limit(100);
          if(!res.error && Array.isArray(res.data)){
            entries = res.data;
          }
          const likeRes = await supabase
            .from('contest_likes')
            .select('entry_id, client_id, user_id')
            .limit(1000);
          if(!likeRes.error && Array.isArray(likeRes.data)){
            likes = likeRes.data;
          }
        }catch(err){
          console.error(err);
          entries = [];
          likes = [];
          networkError = true;
        }
      } else {
        networkError = true;
      }

      if((!entries || entries.length === 0) && networkError){
        setStatus('ネットワークエラーが発生しています');
      }

      const likeCounts = {};
      likedEntries = new Set();
      likes.forEach(l => {
        likeCounts[l.entry_id] = (likeCounts[l.entry_id] || 0) + 1;
        if((supabaseUser?.id && l.user_id === supabaseUser.id) || l.client_id === clientId){
          likedEntries.add(l.entry_id);
        }
      });

      const useEntries = Array.isArray(entries) ? entries : [];
      const enriched = useEntries.map(e => ({
        ...e,
        likeCount: likeCounts[e.id] || e.likeCount || 0
      }));
      cachedEntries = enriched;
      renderEntries(applyFilterAndSort(cachedEntries));
      setStatus('');
    }

    function applyFilterAndSort(entries){
      let filtered = entries.slice();
      if(currentFilter === 'timed10'){
        filtered = filtered.filter(e => e.mode === 'timed10');
      }else if(currentFilter === 'px32'){
        filtered = filtered.filter(e => (e.width || 999) <= 32 && (e.height || 999) <= 32);
      }
      if(currentSort === 'popular'){
        filtered.sort((a,b) => {
          if(b.likeCount !== a.likeCount) return b.likeCount - a.likeCount;
          return new Date(b.submitted_at).getTime() - new Date(a.submitted_at).getTime();
        });
      }else{
        filtered.sort((a,b) => new Date(b.submitted_at).getTime() - new Date(a.submitted_at).getTime());
      }
      return filtered;
    }

  async function likeEntry(id){
    if(!clientId) ensureClientId();
    // オフラインでもトグル可能にする
    const already = likedEntries.has(id);
    if(already){
      likedEntries.delete(id);
    }else{
      likedEntries.add(id);
    }
    const target = cachedEntries.find(e => e.id === id);
    if(target){
      target.likeCount = Math.max(0, (target.likeCount || 0) + (already ? -1 : 1));
    }
    renderEntries(applyFilterAndSort(cachedEntries));

    if(supabase){
      try{
        if(!already){
          const payload = { entry_id:id };
          if(supabaseUser?.id){
            payload.user_id = supabaseUser.id;
          }
          if(supportsClientId){
            payload.client_id = clientId;
          }
          let res = await supabase.from('contest_likes').insert(payload);
          if(res.error && supportsClientId && String(res.error.message || '').includes('client_id')){
            supportsClientId = false;
            delete payload.client_id;
            res = await supabase.from('contest_likes').insert(payload);
          }
          if(res.error) throw res.error;
        }
      }catch(err){
        console.error(err);
      }
    }
  }

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, s => (
        { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s] || s
      ));
    }

    function makePlaceholder(color){
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect width="200" height="200" fill="${color}"/></svg>`;
      return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    }

    function setupPostPanel(){
      const openBtn = document.getElementById('openPostPanel');
      const panel = document.getElementById('postPanel');
      const closeBtn = document.getElementById('closePostPanel');
      if(!openBtn || !panel) return;
      const open = () => {
        panel.classList.add('is-open');
        panel.setAttribute('aria-hidden','false');
      };
      const close = () => {
        panel.classList.remove('is-open');
        panel.setAttribute('aria-hidden','true');
      };
      openBtn.addEventListener('click', open);
      if(closeBtn){
        closeBtn.addEventListener('click', close);
      }
      panel.addEventListener('click', (e) => {
        if(e.target === panel) close();
      });
    }

    async function migrateGuestData(){
      if(!supabase || !supabaseUser?.id || migrationDone || !clientId) return;
      try{
        await supabase.from('contest_entries').update({ user_id: supabaseUser.id }).eq('client_id', clientId);
        await supabase.from('contest_likes').update({ user_id: supabaseUser.id }).eq('client_id', clientId);
        const nick = loadNickname();
        if(nick){
          await supabase.from('user_profiles').upsert({ id: supabaseUser.id, nickname: nick });
        }
        migrationDone = true;
      }catch(err){
        console.error('migrate error', err);
      }
    }

    function updateAuthUI(){
      const btn = document.getElementById('authBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const emailInput = document.getElementById('authEmail');
      const passInput = document.getElementById('authPasscode');
      const authInputs = document.getElementById('authInputs');
      const linkedEmail = document.getElementById('linkedEmail');
      const nick = loadNickname();
      const emailLabel = supabaseUser?.email ? supabaseUser.email : '未ログイン';
      if(!btn) return;
      if(supabaseUser){
        btn.textContent = 'ログインリンクを再送';
        if(logoutBtn) logoutBtn.style.display = 'block';
        setAuthStatus(`ログイン中${supabaseUser.email ? `: ${supabaseUser.email}` : ''}${nick ? ` / ${nick}` : ''}`);
        if(emailInput){
          emailInput.value = supabaseUser.email || emailInput.value;
          emailInput.disabled = true;
        }
        if(passInput){
          passInput.value = '';
          passInput.disabled = true;
        }
        if(authInputs) authInputs.style.display = 'none';
        if(linkedEmail){
          linkedEmail.style.display = 'block';
          linkedEmail.textContent = supabaseUser.email ? `紐付け済み: ${supabaseUser.email}` : '紐付け済み';
        }
      }else{
        btn.textContent = 'メールでログイン';
        if(logoutBtn) logoutBtn.style.display = 'none';
        setAuthStatus(nick ? `ニックネーム: ${nick}` : '');
        if(emailInput){
          emailInput.disabled = false;
        }
        if(passInput){
          passInput.disabled = false;
        }
        if(authInputs) authInputs.style.display = 'grid';
        if(linkedEmail){
          linkedEmail.style.display = 'none';
          linkedEmail.textContent = '';
        }
      }
      applyAvatarToBrand();
    }

    async function initSupabase(){
      try{
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1/+esm');
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          global:{ headers:{ 'x-client-id': clientId || '' } }
        });
        const { data } = await supabase.auth.getSession();
        supabaseSession = data?.session || null;
        supabaseUser = supabaseSession?.user || null;
        supabase.auth.onAuthStateChange((_event, session) => {
          supabaseSession = session || null;
          supabaseUser = session?.user || null;
          migrateGuestData();
          updateAuthUI();
          fetchAndRender();
        });
        await migrateGuestData();
        updateAuthUI();
      }catch(err){
        console.warn('Supabase初期化に失敗: オフラインプレース表示のみ', err);
        supabase = null;
      }
    }

    function setupAuthButton(){
      const btn = document.getElementById('authBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const openBtn = document.getElementById('openProfilePanel');
      const closeBtn = document.getElementById('closeAuthPanel');
      const panel = document.getElementById('authPanel');
      const saveBtn = document.getElementById('saveProfile');
      const nicknameInput = document.getElementById('profileNickname');
      const togglePanel = (open) => {
        if(!panel) return;
        if(open){
          panel.classList.add('is-open');
          panel.setAttribute('aria-hidden','false');
        }else{
          panel.classList.remove('is-open');
          panel.setAttribute('aria-hidden','true');
        }
      };
      if(openBtn) openBtn.addEventListener('click', () => {
        if(nicknameInput){
          nicknameInput.value = loadNickname();
        }
        togglePanel(true);
      });
      if(closeBtn) closeBtn.addEventListener('click', () => togglePanel(false));
      if(panel){
        panel.addEventListener('click', (e) => { if(e.target === panel) togglePanel(false); });
      }
      if(saveBtn){
        saveBtn.addEventListener('click', async () => {
          const nick = (nicknameInput?.value || '').trim();
          if(nick){
            saveNickname(nick);
          }
          applyAvatarToBrand();
          renderAvatarChoices();
          if(supabase && supabaseUser?.id){
            try{
              await supabase.from('user_profiles').upsert({ id: supabaseUser.id, nickname: nick || null, avatar: loadAvatar() });
              setAuthStatus('プロフィールを保存しました');
            }catch(err){
              console.warn('profile save fallback', err);
              setAuthStatus('ローカルに保存しました');
            }
          }else{
            setAuthStatus('ローカルに保存しました');
          }
        });
      }
      if(!btn) return;
      btn.addEventListener('click', async () => {
        if(!supabase){
          setAuthStatus('オンラインでログインしてください');
          return;
        }
        const emailInput = document.getElementById('authEmail');
        const passInput = document.getElementById('authPasscode');
        const email = (emailInput?.value || '').trim();
        const passcode = (passInput?.value || '').trim();
        if(!email){
          setAuthStatus('メールアドレスを入力してください');
          return;
        }
        if(passcode.length < 6 || passcode.length > 20){
          setAuthStatus('パスコードは6〜20文字で入力してください');
          return;
        }
        setAuthStatus('サインインしています...');
        try{
          const { error } = await supabase.auth.signInWithPassword({ email, password: passcode });
          if(error){
            // 既に登録済みで未確認なら再送
            if(String(error.message || '').toLowerCase().includes('confirm')){
              await supabase.auth.resend({ type:'signup', email, options:{ emailRedirectTo: window.location.href } });
              setAuthStatus('確認メールを再送しました。メールを確認してください');
              return;
            }
            const { error: signUpError } = await supabase.auth.signUp({ email, password: passcode, options:{ emailRedirectTo: window.location.href } });
            if(signUpError){
              setAuthStatus('ログイン／登録に失敗しました');
              console.error(signUpError);
              return;
            }
            setAuthStatus('確認メールを送信しました。メールを確認してください');
          }else{
            setAuthStatus('サインインしました');
          }
        }catch(err){
          console.error(err);
          setAuthStatus('ログインに失敗しました');
        }
      });
      if(logoutBtn){
        logoutBtn.addEventListener('click', async () => {
          if(!supabase) return;
          await supabase.auth.signOut();
          supabaseUser = null;
          supabaseSession = null;
          migrationDone = false;
          updateAuthUI();
          fetchAndRender();
          togglePanel(false);
        });
      }
    }

    async function init(){
      ensureClientId();
      setupTabs();
      setupPostPanel();
      setupAuthButton();
      const form = $(FORM_ID);
      if(form){
        const saved = loadNickname();
        if(saved){
          form.name.value = saved;
        }
        form.addEventListener('submit', handleSubmit);
      }
      const profileNick = document.getElementById('profileNickname');
      if(profileNick){
        profileNick.value = loadNickname();
      }
      await initSupabase();
      updateAuthUI();
      renderAvatarChoices();
      applyAvatarToBrand();
      await fetchAndRender();
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
