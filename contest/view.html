<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>ドット作品</title>
  <link rel="icon" type="image/png" href="../character-dots/mao1.png"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Fredoka:wght@600&display=swap" rel="stylesheet">
  <style>
    :root{ color-scheme: dark; }
    *{
      box-sizing:border-box;
      user-select:none;
      -webkit-user-select:none;
      -ms-user-select:none;
    }
    body{
      margin:0;
      font-family:'Fredoka','DotGothic16',system-ui,sans-serif;
      background:radial-gradient(circle at 20% 20%, rgba(59,130,246,0.22), rgba(15,23,42,1)),
                 radial-gradient(circle at 80% 0%, rgba(236,72,153,0.18), rgba(15,23,42,1)),
                 #0b1224;
      color:#e5e7eb;
      min-height:100vh;
      padding:20px 12px 48px;
      display:flex;
      justify-content:center;
    }
    .page{ width:100%; max-width:900px; display:grid; gap:16px; }
    header{
      position:sticky;
      top:0;
      z-index:60;
      background:rgba(11,18,36,0.94);
      backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(255,255,255,0.08);
      margin:-28px -12px 12px;
      padding:10px 14px;
    }
    .header-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:0.01em;
      background:none;
      border:0;
      padding:0;
      cursor:pointer;
    }
    .brand-icon{
      width:34px;
      height:34px;
      border-radius:10px;
      background:rgba(255,255,255,0.12);
      padding:4px;
      border:1px solid rgba(255,255,255,0.2);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .brand-icon img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      image-rendering:pixelated;
      image-rendering:crisp-edges;
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-title{ margin:0; font-size:16px; color:#f9fafb; }
    .brand-sub{ margin:0; font-size:12px; color:#9ca3af; }
    h1{ margin:0; font-size:22px; }
    .auth-panel{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.65);
      backdrop-filter:blur(4px);
      padding:16px;
      z-index:70;
    }
    .auth-panel.is-open{ display:flex; }
    .auth-card{
      width:100%;
      max-width:420px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(255,255,255,0.14);
      border-radius:16px;
      padding:16px;
      box-shadow:0 18px 40px rgba(0,0,0,0.45);
      display:grid;
      gap:12px;
    }
    .auth-input{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.05);
      color:#fff;
      padding:10px 12px;
      font-size:14px;
    }
    .auth-btn{
      border:1px solid rgba(255,255,255,0.2);
      background:linear-gradient(135deg,#4f46e5,#7c3aed);
      color:#fff;
      border-radius:12px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      text-align:center;
    }
    .auth-btn.logout{
      background:rgba(255,255,255,0.08);
      border-color:rgba(255,255,255,0.2);
    }
    .auth-status{ font-size:12px; color:#cbd5e1; min-height:16px; }
    .close-btn{
      border:1px solid rgba(255,255,255,0.2);
      background:rgba(255,255,255,0.08);
      color:#fff;
      border-radius:8px;
      padding:6px 10px;
      cursor:pointer;
    }
    .profile-block{
      display:grid;
      gap:10px;
      padding:10px;
      border-radius:12px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.08);
    }
    .avatar-grid{
      display:grid;
      grid-template-columns:repeat(6, minmax(0, 1fr));
      gap:4px;
    }
    .avatar-option{
      width:100%;
      aspect-ratio:1;
      border-radius:12px;
      border:2px solid transparent;
      background:rgba(255,255,255,0.08);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:800;
      transition:border-color 0.15s ease, transform 0.1s ease;
    }
    .avatar-option.is-active{
      border-color:#7c3aed;
      transform:translateY(-1px);
    }
    .card{
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:12px;
      padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,0.3);
    }
    .entry-hero{
      position:relative;
      width:100%;
      height:min(80vh, 100vw);
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.12);
      overflow:hidden;
      border-radius:12px;
    }
    .entry-hero img{
      width:100%;
      height:100%;
      object-fit:contain;
      image-rendering:pixelated;
      background:transparent;
    }
    .heart-btn{
      position:absolute;
      right:8px;
      bottom:8px;
      border:none;
      background:transparent;
      padding:0;
      width:36px;
      height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      z-index:2;
    }
    .heart-btn img{ width:100%; height:100%; object-fit:contain; display:block; }
    .meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:10px;
    }
    .title{ font-size:18px; font-weight:800; margin:0; }
    .author{ margin:0; color:#cbd5e1; font-size:13px; }
    .likes{ color:#fbbf24; font-weight:800; }
    .gallery{
      display:grid;
      gap:12px;
      grid-template-columns:repeat(3, 1fr);
    }
    .entry-card{
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:0 0 10px 10px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
      text-decoration:none;
      color:inherit;
    }
    .entry-imgwrap{
      padding:0;
      background:transparent;
      display:block;
      position:relative;
      aspect-ratio:1/1;
    }
    .entry-imgwrap img{
      width:100%;
      height:100%;
      object-fit:cover;
      image-rendering:pixelated;
      image-rendering:crisp-edges;
      -ms-interpolation-mode:nearest-neighbor;
      border:0;
      background:transparent;
      position:relative;
      z-index:1;
      pointer-events:none;
      -webkit-user-drag:none;
      user-select:none;
    }
    .entry-watermark{
      position:absolute;
      color:rgba(255,255,255,0.04);
      font-weight:800;
      font-size:14px;
      letter-spacing:0.08em;
      text-shadow:0 0 12px rgba(0,0,0,0.18);
      z-index:2;
      pointer-events:none;
    }
    .entry-card .heart-btn{
      right:4px;
      bottom:4px;
      width:32px;
      height:32px;
    }
    .entry-meta{ padding:10px; display:flex; flex-direction:column; gap:6px; }
    .entry-meta__top{ display:flex; align-items:center; justify-content:space-between; gap:6px; }
    .entry-title{ font-weight:800; color:#f9fafb; }
    .entry-like{ color:#fbbf24; font-weight:800; }
    .entry-author{ margin:0; color:#cbd5e1; font-size:12px; }
    .empty{ color:#cbd5e1; text-align:center; margin:8px 0 0; }
    .status{ color:#fef3c7; font-size:12px; min-height:18px; }
    .danger-btn{
      border:1px solid rgba(248,113,113,0.5);
      background:rgba(248,113,113,0.12);
      color:#fecaca;
      border-radius:10px;
      padding:10px 12px;
      font-weight:700;
      cursor:pointer;
    }
    .danger-btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
  </style>
</head>
<body>
  <div class="page">
    <header aria-label="top-nav">
      <div class="header-inner">
        <button class="brand" id="openProfilePanel" type="button">
          <span class="brand-icon" id="brandAvatar"><img src="../character-dots/mao1.png" alt="logo"></span>
          <div class="brand-text">
            <p class="brand-title">PiXiEED</p>
            <p class="brand-sub">Dot Gallery</p>
          </div>
        </button>
        <div></div>
      </div>
    </header>
    <section class="card">
      <div class="entry-hero" id="hero">
        <img id="heroImg" alt="dot work" draggable="false"/>
        <span class="entry-watermark" style="top:6px; left:6px;">PiXiEED</span>
        <span class="entry-watermark" style="top:6px; right:6px;">PiXiEED</span>
        <span class="entry-watermark" style="right:6px; bottom:6px;">PiXiEED</span>
        <span class="entry-watermark" style="left:6px; bottom:6px;">PiXiEED</span>
        <span class="entry-watermark" style="left:50%; top:50%; transform:translate(-50%,-50%);">PiXiEED</span>
        <span class="entry-watermark" style="left:50%; top:25%; transform:translate(-50%,-50%);">PiXiEED</span>
        <span class="entry-watermark" style="left:50%; top:75%; transform:translate(-50%,-50%);">PiXiEED</span>
        <span class="entry-watermark" style="left:25%; top:50%; transform:translate(-50%,-50%);">PiXiEED</span>
        <span class="entry-watermark" style="left:75%; top:50%; transform:translate(-50%,-50%);">PiXiEED</span>
        <button class="heart-btn" id="heroLike" aria-label="いいね"><img id="heroLikeIcon" alt="like icon"/></button>
      </div>
      <div class="meta">
        <div>
          <p class="title" id="heroTitle">タイトル</p>
          <p class="author" id="heroAuthor">by ???</p>
        </div>
        <span class="likes" id="heroLikes">0</span>
      </div>
      <p class="status" id="viewStatus"></p>
      <button class="danger-btn" id="deleteEntry" style="display:none;">この作品を削除する</button>
      <p class="status" id="deleteNotice"></p>
    </section>
    <section class="card">
      <h2 style="margin:0 0 8px;font-size:16px;">ほかの作品</h2>
      <div id="relatedGallery" class="gallery"></div>
    </section>
  </div>
  <div class="auth-panel" id="authPanel" aria-hidden="true">
    <div class="auth-card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h3 style="margin:0;font-size:16px;color:#f9fafb;">プロフィール</h3>
        <button class="close-btn" type="button" id="closeAuthPanel">閉じる</button>
      </div>
      <div class="profile-block">
        <label style="display:flex; flex-direction:column; gap:6px;">
          <span style="font-weight:700; color:#e5e7eb;">ニックネーム</span>
          <input class="auth-input" id="profileNickname" type="text" placeholder="なまえ" maxlength="32">
        </label>
        <div>
          <p class="author" style="margin:0 0 6px;">アイコン</p>
          <div class="avatar-grid" id="avatarGrid"></div>
        </div>
        <button class="auth-btn" id="saveProfile" type="button">プロフィールを保存</button>
      </div>
      <div class="profile-block">
        <p class="author" style="margin:0 0 6px;">アカウント紐付け</p>
        <p class="author" id="linkedEmail" style="margin:0 0 6px; display:none;"></p>
        <div id="authInputs" style="display:grid; gap:8px;">
          <input class="auth-input" id="authEmail" type="email" placeholder="メールアドレス" autocomplete="email">
          <input class="auth-input" id="authPasscode" type="password" placeholder="パスコード（6〜20文字）" autocomplete="current-password">
        </div>
        <button class="auth-btn" id="authBtn" type="button">メール＋パスコードでログイン</button>
        <button class="auth-btn logout" id="logoutBtn" type="button" style="display:none;">ログアウト</button>
      </div>
      <p class="auth-status" id="authStatus"></p>
    </div>
  </div>
  <script type="module">
    const NFAV_SRC = '../pixiedraw/assets/NFav.png';
    const FAV_SRC = '../pixiedraw/assets/Fav.png';
    const SUPABASE_URL = 'https://kyyiuakrqomzlikfaire.supabase.co';
    const SUPABASE_REST = `${SUPABASE_URL}/rest/v1`;
    const SUPABASE_ANON_KEY = 'sb_publishable_gnc61sD2hZvGHhEW8bQMoA_lrL07SN4';
    const SAMPLE_COLORS = ['#7dd3fc','#f472b6','#facc15','#34d399','#c084fc','#60a5fa','#f59e0b','#a3e635','#f43f5e','#38bdf8'];
    const AVATARS = [
      { id:'mao', type:'img', src:'../character-dots/mao1.png' },
      { id:'jerin1', type:'img', src:'../character-dots/Jerin1.png' },
      { id:'jerin2', type:'img', src:'../character-dots/Jerin2.png' },
      { id:'jerin3', type:'img', src:'../character-dots/Jerin3.png' },
      { id:'jerin4', type:'img', src:'../character-dots/Jerin4.png' },
      { id:'jerin5', type:'img', src:'../character-dots/Jerin5.png' },
      { id:'jerin6', type:'img', src:'../character-dots/Jerin6.png' },
      { id:'jerin7', type:'img', src:'../character-dots/Jerin7.png' },
      { id:'jerin8', type:'img', src:'../character-dots/Jerin8.png' },
      { id:'jellnall1', type:'img', src:'../character-dots/JELLNALL1.png' },
      { id:'jellnall2', type:'img', src:'../character-dots/JELLNALL2.png' },
      { id:'jellnall3', type:'img', src:'../character-dots/JELLNALL3.png' },
      { id:'jellnall4', type:'img', src:'../character-dots/JELLNALL4.png' },
      { id:'jellnall5', type:'img', src:'../character-dots/JELLNALL5.png' },
      { id:'jellnall6', type:'img', src:'../character-dots/JELLNALL6.png' },
      { id:'jellnall7', type:'img', src:'../character-dots/JELLNALL7.png' },
      { id:'jellnall8', type:'img', src:'../character-dots/JELLNALL8.png' },
      { id:'jellnall9', type:'img', src:'../character-dots/JELLNALL9.png' },
      { id:'jellnall10', type:'img', src:'../character-dots/JELLNALL10.png' },
      { id:'jellnall11', type:'img', src:'../character-dots/JELLNALL11.png' },
      { id:'jellnall12', type:'img', src:'../character-dots/JELLNALL12.png' },
      { id:'jellnall13', type:'img', src:'../character-dots/JELLNALL13.png' },
      { id:'jellnall14', type:'img', src:'../character-dots/JELLNALL14.png' },
      { id:'jellnall15', type:'img', src:'../character-dots/JELLNALL15.png' },
      { id:'jellnall16', type:'img', src:'../character-dots/JELLNALL16.png' },
      { id:'jellnall17', type:'img', src:'../character-dots/JELLNALL17.png' },
      { id:'jellnall18', type:'img', src:'../character-dots/JELLNALL18.png' },
      { id:'jellnall19', type:'img', src:'../character-dots/JELLNALL19.png' },
      { id:'baburin', type:'img', src:'../character-dots/baburinpng.png' }
    ];
    let clientId = null;
    let supabaseAuth = null;
    let supabaseSession = null;
    let supabaseUser = null;
    let migrationDone = false;
    let likedEntries = new Set();
    let entry = null;
    let cachedEntries = [];
    let currentEntryId = 0;

    function $(id){ return document.getElementById(id); }

    function setStatus(msg){
      const el = $('viewStatus');
      if(el) el.textContent = msg || '';
    }

    function setAuthStatus(msg){
      const el = $('authStatus');
      if(el) el.textContent = msg || '';
    }

    function loadNickname(){
      try{
        return localStorage.getItem('pixieed_nickname') || '';
      }catch(_){
        return '';
      }
    }
    function saveNickname(name){
      try{
        localStorage.setItem('pixieed_nickname', name);
      }catch(_){}
    }

    function loadAvatar(){
      try{
        return localStorage.getItem('pixieed_avatar') || 'mao';
      }catch(_){
        return 'mao';
      }
    }
    function saveAvatar(id){
      try{
        localStorage.setItem('pixieed_avatar', id);
      }catch(_){}
    }

    function applyAvatarToBrand(){
      const brand = document.getElementById('brandAvatar');
      const avatarId = loadAvatar();
      const found = AVATARS.find(a => a.id === avatarId);
      if(brand){
        if(found && found.type === 'img'){
          brand.style = 'border:1px solid rgba(255,255,255,0.25); background:rgba(255,255,255,0.08);';
          brand.innerHTML = `<img src="${found.src}" alt="avatar">`;
        }else if(found && found.style){
          brand.style = `${found.style} border:1px solid rgba(255,255,255,0.25);`;
          brand.innerHTML = '';
        }else{
          brand.style = 'border:1px solid rgba(255,255,255,0.25); background:rgba(255,255,255,0.08);';
          brand.innerHTML = `<img src="../character-dots/mao1.png" alt="logo">`;
        }
      }
    }

    function renderAvatarChoices(){
      const grid = document.getElementById('avatarGrid');
      if(!grid) return;
      grid.innerHTML = '';
      const current = loadAvatar();
      AVATARS.forEach(a => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `avatar-option${current === a.id ? ' is-active' : ''}`;
        if(a.type === 'img' && a.src){
          btn.style = 'background:rgba(0,0,0,0.7);';
          const im = document.createElement('img');
          im.src = a.src;
          im.alt = a.id;
          im.style.width = '80%';
          im.style.height = '80%';
          im.style.objectFit = 'contain';
          im.style.pointerEvents = 'none';
          im.style.imageRendering = 'pixelated';
          im.style.imageRendering = 'crisp-edges';
          btn.appendChild(im);
        }else{
          btn.style = a.style;
          btn.textContent = '';
        }
        btn.addEventListener('click', () => {
          saveAvatar(a.id);
          renderAvatarChoices();
          applyAvatarToBrand();
        });
        grid.appendChild(btn);
      });
    }

    function setDeleteNotice(msg){
      const el = $('deleteNotice');
      if(el) el.textContent = msg || '';
    }

    function ensureClientId(){
      const KEY = 'pixieed_client_id';
      try{
        const saved = localStorage.getItem(KEY) || window.PIXIEED_CLIENT_ID;
        if(saved){
          clientId = saved;
          if(!localStorage.getItem(KEY)) localStorage.setItem(KEY, saved);
          return;
        }
        const id = crypto.randomUUID ? crypto.randomUUID() : `guest-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;
        localStorage.setItem(KEY, id);
        clientId = id;
      }catch(_){
        clientId = `guest-${Math.random().toString(36).slice(2,8)}`;
      }
    }

    async function migrateGuestData(){
      if(!supabaseAuth || !supabaseUser?.id || migrationDone || !clientId) return;
      try{
        await supabaseAuth.from('contest_entries').update({ user_id: supabaseUser.id }).eq('client_id', clientId);
        await supabaseAuth.from('contest_likes').update({ user_id: supabaseUser.id }).eq('client_id', clientId);
        const nick = loadNickname();
        if(nick){
          await supabaseAuth.from('user_profiles').upsert({ id: supabaseUser.id, nickname: nick });
        }
        migrationDone = true;
      }catch(err){
        console.error('migrate error', err);
      }
    }

    function updateAuthUI(){
      const btn = document.getElementById('authBtn');
      const nick = loadNickname();
      const emailInput = document.getElementById('authEmail');
      const passInput = document.getElementById('authPasscode');
      const authInputs = document.getElementById('authInputs');
      const linkedEmail = document.getElementById('linkedEmail');
      if(!btn) return;
      if(supabaseUser){
        btn.textContent = 'ログアウト';
        setAuthStatus(`ログイン中${supabaseUser.email ? `: ${supabaseUser.email}` : ''}${nick ? ` / ${nick}` : ''}`);
        if(emailInput){
          emailInput.value = supabaseUser.email || emailInput.value;
          emailInput.disabled = true;
        }
        if(passInput){
          passInput.value = '';
          passInput.disabled = true;
        }
        if(authInputs) authInputs.style.display = 'none';
        if(linkedEmail){
          linkedEmail.style.display = 'block';
          linkedEmail.textContent = supabaseUser.email ? `紐付け済み: ${supabaseUser.email}` : '紐付け済み';
        }
      }else{
        btn.textContent = 'メール＋パスコードでログイン';
        setAuthStatus(nick ? `ニックネーム: ${nick}` : '');
        if(emailInput){
          emailInput.disabled = false;
        }
        if(passInput){
          passInput.disabled = false;
        }
        if(authInputs) authInputs.style.display = 'grid';
        if(linkedEmail){
          linkedEmail.style.display = 'none';
          linkedEmail.textContent = '';
        }
      }
    }

    async function initSupabaseAuth(){
      try{
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1/+esm');
        supabaseAuth = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          global:{ headers:{ 'x-client-id': clientId || '' } }
        });
        const { data } = await supabaseAuth.auth.getSession();
        supabaseSession = data?.session || null;
        supabaseUser = supabaseSession?.user || null;
        supabaseAuth.auth.onAuthStateChange(async (_event, session) => {
          supabaseSession = session || null;
          supabaseUser = session?.user || null;
          migrationDone = false;
          await migrateGuestData();
          updateAuthUI();
          if(currentEntryId){
            await fetchEntry(currentEntryId);
            await fetchRelated(currentEntryId);
          }
        });
        await migrateGuestData();
        updateAuthUI();
        applyAvatarToBrand();
      }catch(err){
        console.warn('Supabase auth init failed', err);
        supabaseAuth = null;
      }
    }

    function setupAuthButton(){
      const btn = document.getElementById('authBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const openBtn = document.getElementById('openProfilePanel');
      const closeBtn = document.getElementById('closeAuthPanel');
      const panel = document.getElementById('authPanel');
      const saveBtn = document.getElementById('saveProfile');
      const nicknameInput = document.getElementById('profileNickname');
      const togglePanel = (open) => {
        if(!panel) return;
        if(open){
          if(nicknameInput) nicknameInput.value = loadNickname();
          panel.classList.add('is-open');
          panel.setAttribute('aria-hidden','false');
        }else{
          panel.classList.remove('is-open');
          panel.setAttribute('aria-hidden','true');
        }
      };
      if(openBtn) openBtn.addEventListener('click', () => {
        if(nicknameInput) nicknameInput.value = loadNickname();
        renderAvatarChoices();
        togglePanel(true);
      });
      if(closeBtn) closeBtn.addEventListener('click', () => togglePanel(false));
      if(panel){
        panel.addEventListener('click', (e) => { if(e.target === panel) togglePanel(false); });
      }
      if(saveBtn){
        saveBtn.addEventListener('click', async () => {
          const nick = (nicknameInput?.value || '').trim();
          if(nick) saveNickname(nick);
          applyAvatarToBrand();
          if(supabaseAuth && supabaseUser?.id){
            try{
              await supabaseAuth.from('user_profiles').upsert({ id: supabaseUser.id, nickname: nick || null, avatar: loadAvatar() });
              setAuthStatus('プロフィールを保存しました');
            }catch(err){
              console.warn('profile save fallback', err);
              setAuthStatus('ローカルに保存しました');
            }
          }else{
            setAuthStatus('ローカルに保存しました');
          }
        });
      }
      if(!btn) return;
      btn.addEventListener('click', async () => {
        if(!supabaseAuth){
          setAuthStatus('オンラインでログインしてください');
          return;
        }
        if(supabaseUser){
          await supabaseAuth.auth.signOut();
          supabaseSession = null;
          supabaseUser = null;
          migrationDone = false;
          updateAuthUI();
          await fetchEntry(currentEntryId);
          await fetchRelated(currentEntryId);
          togglePanel(false);
          return;
        }
        let email = window.prompt('メールアドレスを入力してください') || '';
        if(!email){
          setAuthStatus('メールアドレスを入力してください');
          return;
        }
        let passcode = window.prompt('パスコード（6〜20文字）を入力してください') || '';
        if(passcode.length < 6 || passcode.length > 20){
          setAuthStatus('パスコードは6〜20文字で入力してください');
          return;
        }
        setAuthStatus('サインインしています...');
        try{
          const { error } = await supabaseAuth.auth.signInWithPassword({ email, password: passcode });
          if(error){
            if(String(error.message || '').toLowerCase().includes('confirm')){
              await supabaseAuth.auth.resend({ type:'signup', email, options:{ emailRedirectTo: window.location.href } });
              setAuthStatus('確認メールを再送しました。メールを確認してください');
              return;
            }
            const { error: signUpError } = await supabaseAuth.auth.signUp({ email, password: passcode, options:{ emailRedirectTo: window.location.href } });
            if(signUpError){
              setAuthStatus('ログイン／登録に失敗しました');
              console.error(signUpError);
              return;
            }
            setAuthStatus('確認メールを送信しました。メールを確認してください');
          }else{
            setAuthStatus('サインインしました');
          }
        }catch(err){
          console.error(err);
          setAuthStatus('ログインに失敗しました');
        }
      });
    }

    function render(){
      const img = $('heroImg');
      const titleEl = $('heroTitle');
      const authorEl = $('heroAuthor');
      const likesEl = $('heroLikes');
      const likeIcon = $('heroLikeIcon');
      const delBtn = $('deleteEntry');
      if(!entry){
        img.src = '';
        titleEl.textContent = '読み込めませんでした';
        authorEl.textContent = '';
        likesEl.textContent = '';
        if(delBtn) delBtn.style.display = 'none';
        return;
      }
      img.src = entry.image_base64;
      img.alt = entry.title || 'dot work';
      titleEl.textContent = entry.title || '無題';
      authorEl.textContent = `by ${entry.name || '名無し'}`;
      likesEl.textContent = `${entry.likeCount || 0}`;
      const isLiked = likedEntries.has(entry.id);
      likeIcon.src = isLiked ? FAV_SRC : NFAV_SRC;
      const canDelete = (entry.user_id && supabaseUser?.id === entry.user_id) || (!entry.user_id && entry.client_id === clientId);
      if(delBtn){
        delBtn.style.display = canDelete ? 'inline-block' : 'none';
        delBtn.disabled = !canDelete;
      }
      setDeleteNotice(canDelete ? '' : '※この端末から投稿した作品のみ削除できます');
    }

    async function likeEntry(){
      if(!entry) return;
      ensureClientId();
      const already = likedEntries.has(entry.id);
      if(already){
        likedEntries.delete(entry.id);
        entry.likeCount = Math.max(0, (entry.likeCount || 0) - 1);
      }else{
        likedEntries.add(entry.id);
        entry.likeCount = (entry.likeCount || 0) + 1;
      }
      render();
      try{
        if(!already){
          const payload = { entry_id: entry.id };
          if(supabaseUser?.id){
            payload.user_id = supabaseUser.id;
          }
          payload.client_id = clientId;
          await supabaseInsert('contest_likes', payload);
        }
      }catch(err){
        console.error(err);
      }
    }

    async function deleteEntry(){
      if(!entry){
        setDeleteNotice('作品が読み込まれていません');
        return;
      }
      const canDelete = (entry.user_id && supabaseUser?.id === entry.user_id) || (!entry.user_id && entry.client_id === clientId);
      if(!canDelete){
        setDeleteNotice('この作品はこの端末から削除できません');
        return;
      }
      if(!confirm('この作品を削除しますか？')){
        return;
      }
      setStatus('削除しています...');
      try{
        const eq = { id: entry.id };
        if(entry.user_id && supabaseUser?.id === entry.user_id){
          eq.user_id = supabaseUser.id;
        }else if(entry.client_id){
          eq.client_id = entry.client_id;
        }
        await supabaseDelete('contest_entries', { eq });
        setStatus('削除しました');
        setDeleteNotice('');
        location.href = './index.html';
      }catch(err){
        console.error(err);
        setStatus('削除に失敗しました');
      }
    }

    async function fetchEntry(id){
      setStatus('読み込み中...');
      entry = {
        id,
        name: 'サンプル',
        title: 'サンプル作品',
        width: 512,
        height: 512,
        colors: 256,
        image_base64: makePlaceholder(SAMPLE_COLORS[id % SAMPLE_COLORS.length]),
        submitted_at: new Date().toISOString(),
        likeCount: 0,
        mode: 'free',
        client_id: null,
        user_id: null
      };
      try{
        const res = await supabaseSelect('contest_entries', { eq: { id }, limit: 1 });
        if(res.length){
          entry = res[0];
        }else{
          setStatus('ネットワークエラーまたは作品が見つかりません');
        }
        const likeRes = await supabaseSelect('contest_likes', { eq: { entry_id: id }, limit: 2000 });
        entry.likeCount = likeRes.length;
        likeRes.forEach(l => {
          if((supabaseUser?.id && l.user_id === supabaseUser.id) || l.client_id === clientId) likedEntries.add(id);
        });
      }catch(err){
        console.error(err);
        setStatus('ネットワークエラーが発生しています');
      }
      render();
    }

    function renderRelated(entries){
      const wrap = document.getElementById('relatedGallery');
      if(!wrap) return;
      if(!entries.length){
        wrap.innerHTML = '<p class="empty">まだ投稿がありません。</p>';
        return;
      }
      wrap.innerHTML = '';
      entries.slice(0,9).forEach(e => {
        const item = document.createElement('a');
        item.className = 'entry-card';
        item.href = `view.html?id=${e.id}`;
        item.innerHTML = `
          <div class="entry-imgwrap">
            <img src="${e.image_base64}" alt="${e.title}" draggable="false">
            <span class="entry-watermark" style="top:6px; left:6px;">PiXiEED</span>
            <span class="entry-watermark" style="top:6px; right:6px;">PiXiEED</span>
            <span class="entry-watermark" style="right:6px; bottom:6px;">PiXiEED</span>
            <span class="entry-watermark" style="left:6px; bottom:6px;">PiXiEED</span>
            <span class="entry-watermark" style="left:50%; top:50%; transform:translate(-50%,-50%);">PiXiEED</span>
            <span class="entry-watermark" style="left:50%; top:25%; transform:translate(-50%,-50%);">PiXiEED</span>
            <span class="entry-watermark" style="left:50%; top:75%; transform:translate(-50%,-50%);">PiXiEED</span>
            <span class="entry-watermark" style="left:25%; top:50%; transform:translate(-50%,-50%);">PiXiEED</span>
            <span class="entry-watermark" style="left:75%; top:50%; transform:translate(-50%,-50%);">PiXiEED</span>
            <button class="heart-btn" data-id="${e.id}" aria-label="いいね">
              <img src="${likedEntries.has(e.id) ? FAV_SRC : NFAV_SRC}" alt="like icon">
            </button>
          </div>
          <div class="entry-meta">
            <div class="entry-meta__top">
              <span class="entry-title">${escapeHtml(e.title || '無題')}</span>
              <span class="entry-like">${e.likeCount || 0}</span>
            </div>
            <p class="entry-author">by ${escapeHtml(e.name || '名無し')}</p>
          </div>
        `;
        wrap.appendChild(item);
      });
      wrap.querySelectorAll('.heart-btn').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          ev.preventDefault();
          ev.stopPropagation();
          likeEntry(Number(btn.dataset.id));
        });
      });
    }

    async function fetchRelated(currentId){
      cachedEntries = [];
      try{
        cachedEntries = await supabaseSelect('contest_entries', { order: 'submitted_at.desc', limit: 30 });
        const likeRes = await supabaseSelect('contest_likes', { limit: 2000 });
        const likeCounts = {};
        likeRes.forEach(l => {
          likeCounts[l.entry_id] = (likeCounts[l.entry_id] || 0) + 1;
          if((supabaseUser?.id && l.user_id === supabaseUser.id) || l.client_id === clientId){
            likedEntries.add(l.entry_id);
          }
        });
        cachedEntries = cachedEntries.map(e => ({
          ...e,
          likeCount: likeCounts[e.id] || e.likeCount || 0
        }));
      }catch(err){
        console.error(err);
      }
      if(cachedEntries.length === 0){
        cachedEntries = Array.from({ length: 9 }, (_, i) => ({
          id: 500000 + i,
          name: `サンプル${i+1}`,
          title: `サンプル${i+1}`,
          width: 512,
          height: 512,
          colors: 256,
          image_base64: makePlaceholder(SAMPLE_COLORS[i % SAMPLE_COLORS.length]),
          submitted_at: new Date().toISOString(),
          likeCount: 0,
          mode: i % 2 === 0 ? 'timed10' : 'free'
        }));
      }
      renderRelated(cachedEntries.filter(e => e.id !== currentId));
    }

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, s => (
        { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s] || s
      ));
    }

    function makePlaceholder(color){
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect width="512" height="512" fill="${color}"/></svg>`;
      return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    }

    function supabaseHeaders(){
      const token = supabaseSession?.access_token || SUPABASE_ANON_KEY;
      return {
        'Content-Type':'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${token}`,
        'x-client-id': clientId || ''
      };
    }

    async function supabaseSelect(table, { eq = {}, order, limit } = {}){
      const params = new URLSearchParams();
      params.set('select','*');
      Object.entries(eq).forEach(([k,v]) => params.set(k, `eq.${v}`));
      if(order){
        const [col, dir] = order.split('.');
        params.set('order', col);
        if(dir === 'desc'){
          params.set('order', `${col}.desc`);
        }
      }
      if(limit){
        params.set('limit', String(limit));
      }
      const res = await fetch(`${SUPABASE_REST}/${table}?${params.toString()}`, {
        headers: supabaseHeaders()
      });
      if(!res.ok) throw new Error(`supabase select failed: ${res.status}`);
      return res.json();
    }

    async function supabaseInsert(table, payload){
      const res = await fetch(`${SUPABASE_REST}/${table}`, {
        method:'POST',
        headers: supabaseHeaders(),
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error(`supabase insert failed: ${res.status}`);
      return res.json();
    }

    async function supabaseDelete(table, { eq = {} } = {}){
      const params = new URLSearchParams();
      Object.entries(eq).forEach(([k,v]) => params.set(k, `eq.${v}`));
      const res = await fetch(`${SUPABASE_REST}/${table}?${params.toString()}`, {
        method:'DELETE',
        headers: supabaseHeaders()
      });
      if(!res.ok) throw new Error(`supabase delete failed: ${res.status}`);
      return res.json();
    }

    async function init(){
      ensureClientId();
      setupAuthButton();
      await initSupabaseAuth();
      document.addEventListener('dragstart', (e) => {
        if(e.target && e.target.tagName === 'IMG'){
          e.preventDefault();
        }
      });
      const params = new URLSearchParams(location.search);
      currentEntryId = Number(params.get('id')) || 0;
      await fetchEntry(currentEntryId);
      await fetchRelated(currentEntryId);
      render();
      applyAvatarToBrand();
      renderAvatarChoices();
      const likeBtn = $('heroLike');
      if(likeBtn){
        likeBtn.addEventListener('click', likeEntry);
      }
      const delBtn = $('deleteEntry');
      if(delBtn){
        delBtn.addEventListener('click', deleteEntry);
      }
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
