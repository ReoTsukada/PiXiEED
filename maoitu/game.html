<!DOCTYPE html>

<html lang="ja">
<head>
<meta content="https://pixieed.jp/maoitu/ogp.png" property="og:image"/>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" name="viewport"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<meta content="まおいつ" name="apple-mobile-web-app-title"/>
<title>魔王様！！いつまでよければいいですか！？</title>
<meta content="#000000" name="theme-color"/>

<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SZPVXMX85G"></script>
<script>
const GA_MEASUREMENT_ID = 'G-SZPVXMX85G';
const GA_ADDITIONAL_IDS = ['G-LLSD5KLJVN'];
const GA_PAGE_PATH = '/maoitu/game';
const PROJECT_SLUG = 'maoitu';
const PROJECT_NAME = '魔王様!!いつまでよければいいですか!?';
const PROJECT_TYPE = 'game';
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', GA_MEASUREMENT_ID, {
  page_path: GA_PAGE_PATH,
  page_title: document.title
});
GA_ADDITIONAL_IDS.forEach(id => {
  gtag('config', id, {
    page_path: GA_PAGE_PATH,
    page_title: document.title
  });
});
gtag('event', 'project_open', {
  project_slug: PROJECT_SLUG,
  project_type: PROJECT_TYPE,
  project_name: PROJECT_NAME
});
gtag('event', 'project_open_maoitu');
</script>
<!-- Google AdSense -->
<script async="" crossorigin="anonymous" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9801602250480253"></script>
<style>
  :root{
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  html,body{
    margin:0;
    background:#000;
    height:100%;
    overflow:hidden;
    min-height:100svh;
    touch-action:none;
    overscroll-behavior:none;
  }
  body{
    position:relative;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    min-height:var(--vvh, 100svh);
    /* 上部の重なりを最小限にしてキャンバスをさらに上寄せ */
    padding-top:clamp(0px, 1vh, 12px);
    padding-bottom:calc(90px + var(--safe-bottom)); /* 固定広告ぶんの余白を下に確保しつつ余裕を持たせる */
  }
  .ad-header{
    width:100%;
    max-width:640px;
    padding:calc(8px + var(--safe-top)) 0 8px;
    box-sizing:border-box;
    display:flex;
    justify-content:center;
    background:#fff;
    border-bottom:1px solid rgba(0,0,0,0.08);
  }
  .ad-header ins{
    display:block;
    width:320px;
    max-width:320px;
    height:50px;
    overflow:hidden;
  }
  .game-area{
    position:relative;
    flex:1 1 auto;
    width:100%;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:0;
    box-sizing:border-box;
    /* さらに余白を絞ってキャンバスを上へ */
    padding:clamp(0px, 3vh, 24px) 0;
  }
  #c{display:block;touch-action:none;image-rendering:pixelated}
  .back-link{
    position:absolute;
    top:calc(var(--safe-top) + 10px);
    left:18px;
    padding:8px 14px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.35);
    background:rgba(0,0,0,0.65);
    color:#fff;
    font:600 13px/1.2 system-ui;
    text-decoration:none;
    display:none;
    z-index:40;
    transition:background 0.2s ease,color 0.2s ease,transform 0.2s ease;
  }
  .back-link:hover,
  .back-link:focus-visible{
    background:#fff;
    color:#000;
    transform:translateY(-1px);
    outline:none;
  }
  #gameOverUi{
    position:fixed;
    inset:0;
    display:none;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    padding:calc(var(--safe-top) + 20px) 16px calc(var(--safe-bottom) + 20px);
    gap:18px;
    z-index:20;
    box-sizing:border-box;
    max-height:100%;
    overflow:hidden;
  }
  #gameOverPanel{
    width:min(90vw, 336px);
    padding:14px 16px;
    background:rgba(0,0,0,0.85);
    border:1px solid rgba(255,255,255,0.25);
    border-radius:12px;
    color:#fff;
    text-align:center;
    font-family:sans-serif;
    box-sizing:border-box;
    display:flex;
    flex-direction:column;
    gap:8px;
    transition:box-shadow 0.2s ease,border-color 0.2s ease,background 0.2s ease;
  }
  #gameOverPanel.is-clear{
    background:linear-gradient(160deg, rgba(22,163,74,0.25), rgba(0,0,0,0.8));
    border-color:rgba(74,222,128,0.7);
    box-shadow:0 0 18px rgba(74,222,128,0.45);
  }
  .gameover-title{
    font-size:16px;
    font-weight:700;
    letter-spacing:0.06em;
  }
  .gameover-title.is-clear{ color:#4ade80; text-shadow:0 0 6px rgba(74,222,128,0.5); }
  .clear-badge{
    display:none;
    font:800 14px/1.2 system-ui;
    color:#bbf7d0;
    background:rgba(34,197,94,0.18);
    border:1px solid rgba(34,197,94,0.55);
    border-radius:999px;
    padding:6px 10px;
    margin:0 auto;
    text-transform:uppercase;
    letter-spacing:0.08em;
    box-shadow:0 0 10px rgba(34,197,94,0.35);
  }
  #sharePanel{
    display:none;
    flex-direction:column;
    gap:10px;
    padding:12px 16px;
    text-align:center;
    background:rgba(0,0,0,0.8);
    border:1px solid rgba(255,255,255,0.25);
    border-radius:12px;
    color:#fff;
    font-family:sans-serif;
    font-size:12px;
    align-items:stretch;
    width:min(90vw, 336px);
    box-sizing:border-box;
  }
  #sharePanel button{
    font:700 12px system-ui;
    padding:10px 16px;
    border:0;
    border-radius:10px;
    cursor:pointer;
    width:100%;
  }
  #shareScoreLabel{font-size:16px;font-weight:700;text-align:center;}
  #footer{
    position:absolute;
    bottom:calc(var(--safe-bottom) + 12px);
    right:14px;
    color:rgba(255,255,255,0.6);
    font:10px/1.2 monospace;
    user-select:none;
    pointer-events:none;
  }
  .tutorial-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    pointer-events:auto;
    backdrop-filter:blur(2px);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:calc(16px + var(--safe-top)) 16px calc(16px + var(--safe-bottom));
    box-sizing:border-box;
    z-index:120;
  }
  .tutorial-overlay[hidden]{ display:none !important; }
  .tutorial-card{
    width:min(360px, 92vw);
    height:440px;
    background:rgba(0,0,0,0.86);
    border:1px solid rgba(255,255,255,0.25);
    border-radius:14px;
    color:#fff;
    padding:16px;
    box-sizing:border-box;
    font:14px/1.6 system-ui;
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow:hidden;
  }
  .tutorial-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .tutorial-card h3{
    margin:0;
    font-size:16px;
    letter-spacing:0.04em;
  }
  .tutorial-pages{
    display:flex;
    align-items:center;
    gap:6px;
    font:12px/1 system-ui;
    color:#cbd5e1;
  }
  .tutorial-figure{
    width:100%;
    height:180px;
    background:rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }
  .tutorial-figure img{
    max-width:100%;
    max-height:100%;
    object-fit:contain;
    image-rendering:pixelated;
    display:block;
  }
  .tutorial-text{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:8px;
    overflow:hidden;
    font-size:13px;
    line-height:1.6;
  }
  .tutorial-text p+p{
    margin-top:2px;
  }
  .tutorial-text p{
    margin:0;
  }
  .tutorial-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .tutorial-actions button{
    padding:10px 14px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.25);
    background:rgba(255,255,255,0.08);
    color:#fff;
    font:13px/1.2 system-ui;
    cursor:pointer;
  }
  .tutorial-actions button.primary{
    background:#22c55e;
    color:#000;
    border:none;
    font-weight:700;
  }
  .tutorial-actions button:disabled{
    opacity:0.5;
    cursor:not-allowed;
  }
  .tutorial-open-btn{
    position:absolute;
    top:calc(var(--safe-top) + 12px);
    right:20px;
    display:block;
    padding:8px 12px;
    background:rgba(0,0,0,0.7);
    border:1px solid rgba(255,255,255,0.3);
    border-radius:999px;
    color:#fff;
    font:14px/1 system-ui;
    cursor:pointer;
    z-index:5;
  }
  .ad-footer{
    position:fixed;
    left:0;
    right:0;
    bottom:0;
    width:100%;
    max-width:640px;
    margin:0 auto;
    padding:6px 0 calc(10px + var(--safe-bottom, 0px));
    box-sizing:border-box;
    display:flex;
    justify-content:center;
    background:#000;
    border-top:1px solid rgba(255,255,255,0.08);
    z-index:30;
  }
  .ad-footer ins{
    display:block;
    width:320px;
    max-width:320px;
    height:40px;
    overflow:hidden;
  }
</style>
<link href="../character-dots/mao1.png" rel="icon" type="image/png"/></head>
<body>
<div class="game-area">
  <a class="back-link" href="./index.html" id="backLink">← スタート画面に戻る</a>
  <audio autoplay="" hidden="" id="bgm" loop="" src="bgm.mp3" volume="0.5"></audio>
  <canvas id="c"></canvas>
  <button class="tutorial-open-btn" id="tutorialOpenBtn" type="button">?</button>
  <div id="gameOverUi">
  <div id="gameOverPanel">
  <div class="gameover-title" id="gameoverTitle">GAME OVER</div>
  <div class="clear-badge" id="clearBadge">GAME CLEAR!</div>
  <div id="shareScoreLabel">SCORE: 0</div>
  </div>
<div id="sharePanel">
  <button id="shareActionBtn" style="background:#22c55e;color:#000;">シェアする</button>
  <button id="restartActionBtn" style="background:#3b82f6;color:#fff;">もう一度遊ぶ</button>
  <button id="tutorialAgainBtn" style="background:#6b7280;color:#fff;">チュートリアル</button>
  <button id="nextDifficultyBtn" style="background:#f97316;color:#fff;display:none;">次の難易度へ</button>
</div>
</div>
</div>
<div class="tutorial-overlay" hidden id="tutorialOverlay">
  <div class="tutorial-card">
    <div class="tutorial-header">
      <h3>チュートリアル</h3>
      <div class="tutorial-pages" id="tutorialPages"></div>
    </div>
    <div class="tutorial-figure">
      <img alt="ゲームプレイの参考画像" id="tutorialImg" src="./ogp.png"/>
    </div>
    <div class="tutorial-text" id="tutorialText">
      <p></p>
    </div>
    <div class="tutorial-actions">
      <button id="tutorialPrev" type="button">← 戻る</button>
      <button class="primary" id="tutorialNext" type="button">次へ →</button>
    </div>
  </div>
</div>
<div class="ad-footer">
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9801602250480253"
     data-ad-slot="2141591954"></ins>
</div>
<div id="footer">© 2025 アルタ</div>
<script>
// 広告レンダリング
try{(adsbygoogle = window.adsbygoogle || []).push({});}catch(e){}
// Prevent pinch-zoom on iOS to keep the layout stable.
['gesturestart', 'gesturechange', 'gestureend'].forEach((eventName) => {
  document.addEventListener(eventName, (event) => {
    event.preventDefault();
  }, { passive: false });
});

document.addEventListener('touchmove', (event) => {
  if(event.touches.length > 1){
    event.preventDefault();
  }
}, { passive: false });

const bgm = document.getElementById('bgm');
bgm.volume = 0.5;
const AUDIO_KEY = 'maoitu_audio';
const GAME_CANONICAL_URL = `${window.location.origin}/maoitu/`;
function lsGet(key){
  try{
    return localStorage.getItem(key);
  }catch(_){
    return null;
  }
}
function lsSet(key, value){
  try{
    localStorage.setItem(key, value);
  }catch(_){
    // 無視（プライベートモードなどで弾かれるケース）
  }
}
function setViewportHeight(){
  if(window.visualViewport){
    document.documentElement.style.setProperty('--vvh', `${window.visualViewport.height}px`);
  }else{
    document.documentElement.style.setProperty('--vvh', `${window.innerHeight}px`);
  }
}
setViewportHeight();
window.addEventListener('resize', setViewportHeight);
window.addEventListener('orientationchange', setViewportHeight);
function syncAudioSetting(){
  const enabled = lsGet(AUDIO_KEY) !== 'off';
  bgm.muted = !enabled;
  if(!enabled && !bgm.paused) bgm.pause();
  return enabled;
}
let audioEnabled = syncAudioSetting();
const gameOverUi = document.getElementById('gameOverUi');
const sharePanel = document.getElementById('sharePanel');
const gameOverTitle = document.getElementById('gameoverTitle');
const shareScoreLabel = document.getElementById('shareScoreLabel');
const shareActionBtn = document.getElementById('shareActionBtn');
const restartActionBtn = document.getElementById('restartActionBtn');
const tutorialAgainBtn = document.getElementById('tutorialAgainBtn');
const nextDifficultyBtn = document.getElementById('nextDifficultyBtn');
const tutorialOpenBtn = document.getElementById('tutorialOpenBtn');
const backLink = document.getElementById('backLink');
const gameOverPanel = document.getElementById('gameOverPanel');
const clearBadge = document.getElementById('clearBadge');
const tutorialOverlay = document.getElementById('tutorialOverlay');
const tutorialPagesEl = document.getElementById('tutorialPages');
const tutorialImgEl = document.getElementById('tutorialImg');
const tutorialTextEl = document.getElementById('tutorialText');
const tutorialPrevBtn = document.getElementById('tutorialPrev');
const tutorialNextBtn = document.getElementById('tutorialNext');
// v2: チュートリアルを新規表示するためキーを更新
const TUTORIAL_KEY = 'maoitu_tutorial_seen_v2';
let tutorialPage = 0;
let tutorialActive = false;
const tutorialSlides = [
  {
    img: './assets/1.png',
    alt: '操作方法の例',
    lines: [
      '操作は左右のみ：タップ/ドラッグ、または ←→ キーで移動。',
      '敵に触れると即アウト。まずは動かすだけでOK。'
    ]
  },
  {
    img: './assets/2.png',
    alt: 'エンジェリンとシールド',
    lines: [
      '緑のエンジェリンを取ると盾1回分＋フィーバーゲージが増える。',
      '盾は1回だけ身代わり。なくなったら再び拾って補充しよう。'
    ]
  },
  {
    img: './assets/3.png',
    alt: 'フィーバーの説明',
    lines: [
      'ゲージ満タンでフィーバー発動：加速＋無敵、敵に触れると消して少し延命＆スコア2倍。',
      'ボムリンだけはフィーバーでも即アウトなので必ず避ける。'
    ]
  },
  {
    img: './ogp.png',
    alt: '攻め方の例',
    lines: [
      'フィーバー中に敵に触れて延命しつつ稼ぎ、終わる前に次のエンジェリンを狙うとループしやすい。',
      'まずは30秒生存を目標に、慣れたらフィーバー連鎖でハイスコアを狙おう。'
    ]
  }
];
let shareScore = 0;
let runCleared = false;

function openTutorial(){
  if(!tutorialOverlay) return;
  tutorialActive = true;
  tutorialOverlay.hidden = false;
  tutorialOverlay.removeAttribute('hidden');
  tutorialOverlay.style.display = 'flex';
  tutorialPage = 0;
  renderTutorial();
  if(typeof tutorialOverlay.focus === 'function'){
    try{ tutorialOverlay.focus(); }catch(_){}
  }
}

function closeTutorial(markSeen = false){
  if(!tutorialOverlay) return;
  tutorialActive = false;
  tutorialOverlay.hidden = true;
  tutorialOverlay.setAttribute('hidden','hidden');
  tutorialOverlay.style.display = 'none';
  if(markSeen){
    lsSet(TUTORIAL_KEY, '1');
  }
}

function renderTutorial(){
  if(!tutorialOverlay) return;
  const slide = tutorialSlides[tutorialPage] || tutorialSlides[0];
  if(tutorialImgEl && slide.img){
    tutorialImgEl.src = slide.img;
    tutorialImgEl.alt = slide.alt || 'チュートリアル画像';
  }
  if(tutorialTextEl){
    tutorialTextEl.innerHTML = '';
    slide.lines.forEach(line=>{
      const p = document.createElement('p');
      p.textContent = line;
      tutorialTextEl.appendChild(p);
    });
  }
  const total = tutorialSlides.length;
  if(tutorialPagesEl){
    tutorialPagesEl.textContent = `${tutorialPage + 1} / ${total}`;
  }
  const isFirst = tutorialPage === 0;
  const isLast = tutorialPage === total - 1;
  if(tutorialPrevBtn){
    tutorialPrevBtn.disabled = isFirst;
  }
  if(tutorialNextBtn){
    tutorialNextBtn.textContent = isLast ? 'ゲーム開始' : '次へ →';
  }
}

function logPlayEvent(eventName, params={}){
  if(typeof window.gtag === 'function' && GA_MEASUREMENT_ID){
    window.gtag('event', eventName, params);
  }
}

function logPlayStart(){
  logPlayEvent('play_started');
}

function shareText(score){
  return `開発者:@PiXiEED_arta\n『魔王様！！いつまでよければいいですか！？』\nスコア: ${score}\n皆もやってみてね！！！\n\nリンクから遊べるよ！！#PiXiEED\n\n${GAME_CANONICAL_URL}`;
}

async function copyShareText(text){
  try{
    await navigator.clipboard.writeText(text);
    alert('シェア用テキストをコピーしました！');
  }catch(err){
    alert('シェア機能が利用できません。手動でスコアを共有してください。');
  }
}

shareActionBtn.addEventListener('click', async () => {
  const text = shareText(shareScore);
  copyShareText(text);
});

restartActionBtn.addEventListener('click', () => {
  hideSharePanel();
  reset();
});

if(tutorialPrevBtn){
  tutorialPrevBtn.addEventListener('click', () => {
    if(tutorialPage > 0){
      tutorialPage -= 1;
      renderTutorial();
    }
  });
}

if(tutorialNextBtn){
  tutorialNextBtn.addEventListener('click', () => {
    const isLast = tutorialPage === tutorialSlides.length - 1;
    if(isLast){
      closeTutorial(true);
    }else{
      tutorialPage = Math.min(tutorialSlides.length - 1, tutorialPage + 1);
      renderTutorial();
    }
  });
}

if(tutorialOverlay){
  tutorialOverlay.addEventListener('click', (e) => {
    // 背景クリックで閉じる
    const isLast = tutorialPage === tutorialSlides.length - 1;
    if(isLast && e.target === tutorialOverlay){
      closeTutorial(true);
    }
  });
}

if(tutorialAgainBtn){
  tutorialAgainBtn.addEventListener('click', () => {
    openTutorial();
  });
}

if(tutorialOpenBtn){
  tutorialOpenBtn.addEventListener('click', () => {
    openTutorial();
  });
}

if(nextDifficultyBtn){
  nextDifficultyBtn.addEventListener('click', () => {
    const params = new URLSearchParams(location.search);
    const current = params.get('mode') || readDifficulty();
    const next = nextDifficultyKey(current);
    params.set('mode', next);
    window.location.search = params.toString();
  });
}

function showBackLink(){
  backLink.style.display = 'inline-flex';
}

function hideBackLink(){
  backLink.style.display = 'none';
}

function showSharePanel(score){
  shareScore = score;
  shareScoreLabel.textContent = `SCORE: ${score}`;
  if(gameOverTitle){
    gameOverTitle.textContent = runCleared ? 'GAME CLEAR!' : 'GAME OVER';
    gameOverTitle.classList.toggle('is-clear', runCleared);
  }
  if(gameOverPanel){
    gameOverPanel.classList.toggle('is-clear', runCleared);
  }
  if(clearBadge){
    clearBadge.style.display = runCleared ? 'inline-flex' : 'none';
  }
  if(nextDifficultyBtn){
    nextDifficultyBtn.style.display = runCleared ? 'block' : 'none';
  }
  gameOverUi.style.display = 'flex';
  sharePanel.style.display = 'flex';
  if(typeof restartActionBtn.focus === 'function'){
    try{
      restartActionBtn.focus({ preventScroll: true });
    }catch(_){
      restartActionBtn.focus();
    }
  }
}

function hideSharePanel(){
  sharePanel.style.display = 'none';
  gameOverUi.style.display = 'none';
}
hideSharePanel();
function showTutorialIfNeeded(){
  const seen = lsGet(TUTORIAL_KEY) === '1';
  if(!seen){
    openTutorial();
  }
}
showTutorialIfNeeded();
function isOnSharePanel(target){
  return gameOverUi.style.display !== 'none' && gameOverUi.contains(target);
}
function isOnInstructionUi(){
  return false;
}
// モバイル環境での自動再生対策
document.addEventListener('click', () => {
  audioEnabled = syncAudioSetting();
  if (audioEnabled && bgm.paused) {
    bgm.play().catch(()=>{});
  }
}, { once: true });
// ====== 画像（Base64） ======
// ====== 敵キャラ（解禁スケジュール付き） ======
const ENEMY_TYPES_DATA=[
  {name:"ジェリン",src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAQRJREFUOI3tkjFLA0EQhb89L8LBHZxFmq3sAoKQTgj4A6yutrT0F6W0s7cKgl2CcF2qgJ0gbJPCg12InCFjIXe5jWsg1k45s9/beY+B/1KBnhzC7AqIyJafORzA3K5TgIWF8aDncSoEzxzu3qxTU23FltUGY1ZcjVJPJArBc+vDAP08QuuEybPj9uWztRp3HzXw01s4hn4eAcmPQGRqxQOX1WaPwHfpXDEe9FoLLCx74d9mEZ2U/1JtBqYSHi6OveHp3TsArzcnXr8oa86yzgbN+qPHDwCmVtzuT02vKGt0rhhmsaNzB1KUdevRmFVwXa0Trs+PGGaxu8xUCijvkA60rwC+AHX1dn623PVvAAAAAElFTkSuQmCC",speed:1.8,unlockSec:0},
  {name:"ポワリン",src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAPlJREFUOI2dU7EOgjAUvFZ+wriQAGFB6wc4+AksfCUO+CcYXYjVzTgykxjqgK+2tGj0kibtpXe9tFcGP9QEz74RCgDqo1+/Xurt7gSAGgtFBuz2rlmRc61lplhkw+JwAs4Xhdu9d8SLObdMAm9WA42cNqEETnQ6vZE9zpeH5pNoOC+NORZzjiLnCMZCAJZYXjvLPIkCNLLXKXQWkQ3CT2J57axElgHd9pTYNPEa/II05kgi9r+B+QoEVVa9ejVRj3DVqnDVOnx9VDS3E5TV8Oa+KhNnFg7jKpPBuANJFCCNObabGUQGMPZusfczkRGBLuzbZ3KMPHD2PwEgq485RM69+AAAAABJRU5ErkJggg==",speed:1.3,unlockSec:5},
  {name:"ブリン",src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAARNJREFUOI1jZMAO/uMQZyQowMDA8P//f4j+W+sRgvf3/GXwmMaCoYcFl+YT3f8wTO5XeM9Q+EDwP7IhTIRsRga8omwM/QrvGZC9yESsZgYGBgYZU3YMQxjxaX53B+KNjw+wh6nHNBZEGCD7WUiFiWFb0Qe4sxkYGBgEZFkZPjz+jeIauBdw2YxLMzJgwiqKppmBgYHh8+tfxBsA8zNMM48ETnsgYfDuzj+MgII5G9lmZDa/AgeK+v/9Cu//Q6MGjueYfv0/x/QrhvjNdf9hbLgXGAsfCMLil+HmOsxog4ndXPefQT2IkQGWGtHzwv9+hffwAEQHtpVcKJqxGQA3RNOLF0WQX4GRwbKMGUMPNgMYSMnOAMtAf3plqr/eAAAAAElFTkSuQmCC",speed:2.3,unlockSec:15},
  {name:"シャボリン",src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAYBJREFUOI2lU79rwkAYfQkRO2TIcNDRGxxFupR2EFwzNHuH/gn9D3TsnyLY/RxuFHRI6SCImwGzqSRDhoBK1K+Ll56n0qEf3PLuvXffj/ssXA+6gVsm4FwVSuLCA9cvggwxfEsZl0bWmVgSL+7x5jRTP7Xdum7Ajnm0nzJZWaMH34qV1jHF2cP2nUX50MuZlDuMAcCvogV31XCa8IspQ0USP2VTJkDFhDoJbZY0X/RFSO2ENks6JKNiQh0RUluE1Kb5oq8wvU8ESTU6JCNdLEJqQ1JNP7oJJNUAkA0AwgNPbbe+z/ns+Wn7GX7dvQYZYr0HwgMPMsT7nM9S262rJts6Se4wZsc8MsVlH04cHbdN4n7KpImZI71p4FfRMl8QHvjLY/pxNhEtHJw+CUWr4WDHxyp94YEr8uCbdYMMsfDAHTdusKMbBdndWZmkjeb3qAkYuD7GsoTKGr1iQl0ASGizUlmo+hVWTKhbWaOndP/+yuZ2/bVMqu6ry3RpdBkX/B/RH/qbfqrLJgAAAABJRU5ErkJggg==",speed:0.5,unlockSec:25},
  {name:"プリズリン",src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAQZJREFUOI2Nk01OwzAQhb+ReoCyJyAWEXeouuNnBYfpSVhwgFwBiQVRxK7tHUBIQRRxjsdmpnJdOzCSZfnZ74szMzbqoWxtpUOzmlkSwCfwCGBmKkFKAGm9BuiBS9c6SUVIDpC2IywueuAtATQ1SArQdy9YEOYd8O5757WbBECvgzi9OTB/ALe+3yYfOoDMAD3phyuOzF/+C8MfECRplDR66fbD9YeCvpK0ilLvhRAlvcQsaZ5pcx93gNIkdkAj6R5oJQ2RA0knPjfAEtikVTAzi8bpEmDrOYlogGs/szSz50giE5CzKXPeByXILumDI3MOmLrJpmQuAXIInjRKZmpP1ONfz/kX+Gq5jszpIJsAAAAASUVORK5CYII=",speed:2.8,unlockSec:35},
  {name:"ヘドリン",src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAZZJREFUOI2FUzFrwkAU/myPpEMI4qSCEIhYiwUHh3S8rdQhP8HY31HEtFC6SceO1qHQrUgRnAzdHKQEWihSMYtb1gy1adPBXryYtH5wy/fe++67d++lkIzgDz61jQgAQHc1s/qhm1f3Zw4L+Lag4HYZq9uNFBsCWoMLSHs5CJ+iIte868BfpI9OtIf945w1yy6U76yQhv1lAjgHgB2+mFSXTiGTdyVPprbYNwGgVNMslVAKAPWG1iXVpQNDCN0Sdj2pLp1iBc6jd2NBTG6ASiitN9Ad9MZNH1CYgwCGgGIFTqmmWSx50Bs3p5MxBQDJk6lKKJU8OXTCXLAngBUzu8UKwgbaYt+UPJkWMnkXAJhw5AkqoXTmW9amIC9ie+vY290z5ZsYszmdjClz8x9CgaTu8+62CnSeTl9YMcPMtyyVUHoglg95nu8BQ0A6mP/+bXh0V2vrrtbe5LnctQAMIQy0FpcBgKA8xKg8xIjnSAdzGAITi+xCOI3Y+EYAeH9dDQ63E6lNAYS2VkMSR8IyxdYzIhRHLP8H/uGrhM0W27cAAAAASUVORK5CYII=",speed:1.2,unlockSec:45,sticky:true},
  {name:"バブリン",src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAOVJREFUOI3tULsKwkAQnMQHCkZiYZMqnWCjpXZ2lqns9Wf8BUvt/YUgSEBMJwipBSFNCoMXEcRkLcJdyBkLW3GaW2aZ2bkB/vgBKAUcfaORDYgo02+u6ezd4vRlwKJTyekUWbxlhGMUwz6/BwnCBD2zlDPhBuQwig7s2bDPhCBMCrO3dRUAYOiKMFH5MiZqeAwfxTyBjDIfjlEMPyTsxjWxNJcXAMBp1hKc5T7Q1TIDkcBjGekwiuRLnDN0BX2tLPa5Ei33gSBM4Pt3Qe6nawxWk/TvRh3zYRWjpgq5RGHysYA8hO4F8NhaA9cs3eAAAAAASUVORK5CYII=",speed:1.0,unlockSec:65},
  {name:"ボムリン",src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAQFJREFUOI2Vkz1qxDAQhb8xLhdyggW1SuNib5EyPzA+Sw4UyJI2Tc6whSu1gr3CVsGgFN4xWktKyAM1T/N+ECOhjtTg5S8iAQzDgPf+5iKEwDRNJHqEWRJ9EmbJDZIJnXPV+N35xOv3F4zAG8gR6Vpi7/16AKbPj2VyzOv2yQwKcV59dz4BcNkfGN8VHnvkCMIsnaXXEEJYk4eHJ2KMSwl95qpZGmwfzMSGy/6wirct+1ay4e5+EbcetquReSPnXFNcGFjNvMEWNnNjkAtijMVQjd+GJFVN101cj6o2edvaLndU1cXtpaxunKrepFdX+TfYnzDtvz/TNrj4nrlRBcX8DyFAhQiIvZawAAAAAElFTkSuQmCC",speed:1.2,unlockSec:75,ignoreShield:true},
  {name:"デモリン",src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAATNJREFUOI2lkrFKw1AYhb8rjWNBUJvFwaFeqF3yAJ0UnLPE0aew+AhCn6JLoQ7tXLBQ8AGkQwfjIMWltULAodA4/A5tYm5uiqIH7vLfc05uzn/gn1CAbJkXweIqQMJuzMvjnNnTB2/vM64fzopMpNUYcrjv4uoyx16Fk8vd9UXYjWXjLoBEnie5r0mrMTQ4GQ1ZskSeJyOtDfIWYwGklH/qeLlk5d8zKAhg3D+3csqKZXDzmuawiOaG+GCvkv7/xe2RZSBtf1IozCMxuuqfAqid5MLV5R/FAItojqvL1lzCbmyF16x3pFnvGLOR1sYG0hdUA4dprbd2E7tbyWxa61ENnHSuTI7wfPdplAowylMNHJSyFvBtkpx8cXInRSlnoDJGtP0JbAIGjPX9Blur+1cUGnwBRRiqy88D/g4AAAAASUVORK5CYII=",speed:2.0,unlockSec:85,followPlayer:true,followStrength:0.2},
  {name:"ガオリン",src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAANlJREFUOI3FUrENwzAMo4Oekjc6NKO+8BX2lmQLeoT2PpFBPSojO9mwGyfpVgEGDJmiSMnAv8Md5PkrtmsVk4SZgSRUFWZ2RIpbU5arm6nqgdC9grKLS7L7vi/fm0qSdJJkAWQIId+/3nOXyjvmGe9hwLIsFXuMEfd1BcYxWdwNlSEEliEiFJEqVyg6LjazXJyOmZ2SVICrMLM9AUlymqoBtobKaaoG2QGgiMB7j7htAIDX87FbUcrFbYP3HiKS157Zf7FRyK9sUFUvSVJxwpa7TEzu7Kc1MO4Drbc0qIgGYWoAAAAASUVORK5CYII=",speed:1.6,unlockSec:95,zigzag:true,hSpeed:1.3},
  {name:"グラビリン",src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAU9JREFUOI2Nkj1Lw1AUhp9o90ChiFAkv0B36ZzZRXB08C90cBeEBP0BnUQHhy4Zy93jUoRQnNql1cEvhAsZFLG8DrUxaZPqC5f7wX2fc+85B1ZLP6NSa6vMcSR6sVgFqZVEBCCORDwMYQjRQOxtO3mIUwbQe1ekdRilEA9DfN8HwPRCzKN4a0Bt/YV9Z0NzSOEFaR0ubkMAfN/H87xsba5m55vtneocjFIKZtd1cV0Xz/Oy1zSZlAI0/3PePFce0g8tT+oU8qU4koIgUJIkstaqStZaJUmiIAik1zMBWgNIG1VFWqHRZ2GraCDlGkdAFnnp/Oa0tMFkHpUZFwHZvGB28oDrL/FwvlzG8XiMMQaA9lYd5+Ao8xYAXT3zQUKTCf3Q/jaSMbRbU7hvwN0hzkmtFFAozZM6XIZ2FrU1xdk9zt9b9JVKej2rTNh/9af5GyQ23ONUaR1XAAAAAElFTkSuQmCC",speed:2.0,unlockSec:105,sizeMult:1.5}
];
const PLAYER_SRC="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAQRJREFUOI3tkDtOw1AQRY+hQ7iI05CPkFLYRUSNKHARBbEFV6whBRtIFhCldZcNsAtTIJBYgC3hipgGGztBIDePwt+Xj9JSZKSnuXP15s7MhUP8sxhkSQCirV9sxYM9GsIBMbwbCfJcx04uUm84LpHahTQZn5ye83qm0jT6zB7mfLwFfN3eEP8m/Cy+eUljULsT0gQABQDNgNAVXN7D9RU0WtWIKMjqKMjqxyd4noJmKIRuLgBycxTA+6d8XKdZ4UIElKOS7Om7m0HmevqmeVh23SRRcFi2xDkFn5tZbeB7mJYNgLMUq/UJBWdaNvheyW+auGU9KXxPMrEKzYD1E3a97C8AfzBBfBZb3sdTAAAAAElFTkSuQmCC";
const ANGEL_SRC="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAARZJREFUOI2lkz1OxDAQRt9YCAGSG0REg5ZqC67ABTgB0jZ0ewMqTkC1N6CjQeIEcACuQJGKFRJCRttYWtA2Q+FMsk4C4eer7PE8zzcZB/4pAbS1N2lPbudMANWHSxhvIsV5E7u5yunJtDkLMyhXyPEFDoB5AeUKDbPm9lFAJtMEjkJd2WDmRWZLAdadVJc1DixWVbawkKvd91eSzgLQa73jgCeOgP23mBGve55H4JlDzuSkZusWVH9a3Lwn3gF6//I7GKBi1AEsw2B+R8Y4gK04kN0jYxyA/4MDYzYAxj5tpDVV+7B9cWOSg0UOtB/ResxyjKnH+H6rxF0oI8QCPjzspNfKMqSefUhu/QK2T9MYv/v7hiQAn7kqbU+zGAhDAAAAAElFTkSuQmCC";

// ====== 画像読み込み & アルファマップ ======
function withAlpha(src){
  const img=new Image(); img.src=src;
  const out={img,ready:false,alpha:null};
  img.onload=()=>{
    const oc=document.createElement('canvas'); oc.width=16; oc.height=16;
    const ctx=oc.getContext('2d'); ctx.drawImage(img,0,0,16,16);
    out.alpha=ctx.getImageData(0,0,16,16).data; out.ready=true;
  };
  return out;
}
const ENEMY_TYPES=ENEMY_TYPES_DATA.map(t=>({...t,skin:withAlpha(t.src)}));
const PLAYER=withAlpha(PLAYER_SRC);
const ANGEL=withAlpha(ANGEL_SRC);
const PLAYER_START_X = 86;
const PLAYER_START_Y = 232;
const PLAYER_START_TX = 96;

// ====== 基本設定 ======
let c=document.getElementById('c'),x=c.getContext('2d',{alpha:false}),W=192,H=288;
function createBackground(){
  const oc=document.createElement('canvas');
  oc.width=W; oc.height=H;
  const ctx=oc.getContext('2d');
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#0a0f2a');
  g.addColorStop(1,'#060912');
  ctx.fillStyle=g;
  ctx.fillRect(0,0,W,H);
  return oc;
}
function createStarLayer(count=36,minR=0.2,maxR=1.6,alphaMin=0.05,alphaMax=0.4,heightRatio=0.8){
  const oc=document.createElement('canvas');
  oc.width=W; oc.height=H;
  const ctx=oc.getContext('2d');
  for(let i=0;i<count;i++){
    const r=Math.random()*(maxR-minR)+minR;
    const alpha=Math.random()*(alphaMax-alphaMin)+alphaMin;
    ctx.fillStyle=`rgba(255,255,255,${alpha})`;
    ctx.beginPath();
    ctx.arc(Math.random()*W,Math.random()*H*heightRatio,r,0,Math.PI*2);
    ctx.fill();
  }
  return oc;
}
const BG_LAYER=createBackground();
const STAR_LAYER=createStarLayer(); // 遠景
const STAR_LAYER_NEAR=createStarLayer(48,0.15,0.9,0.2,0.6,1); // 手前の細かい星
let starOffset=0;
let starOffsetNear=0;
const STAR_SCROLL_SPEED=0.25;
const STAR_SCROLL_SPEED_NEAR=0.55;
const HITSTOP_ON_SHIELD_FRAMES = 3;  // 短めにしてカクつきを抑制
const HITSTOP_ON_FATAL_FRAMES = 6;
const SHAKE_INTENSITY_SHIELD = 1.0;
const SHAKE_INTENSITY_FATAL = 1.4;
const SHIELD_FLASH_FRAMES = 14;
const FEVER_THRESHOLD_FRAMES = 900; // 約15秒
const FEVER_DURATION_FRAMES = 240; // 4秒
const FEVER_SPEED_SCALE = 1.25; // フィーバー中はむしろ加速
const FEVER_PLAYER_SPEED_MULT = 1.2;
const FEVER_SCORE_MULT = 2;
const FEVER_HIT_BONUS_FRAMES = 15; // フィーバー中に敵に触れたときの延命量（短め）
const FEVER_GAUGE_BOOST_ON_PICKUP = 120;
let P={x:PLAYER_START_X,y:PLAYER_START_Y,w:16,h:16,v:4,skin:PLAYER};
let E=[], angels=[], o=0, tx=PLAYER_START_TX, S=0, alive=true, shieldCharges=0;
let hitstopFrames=0;
let shieldFlashFrames=0;
let shakeFrames=0;
let shakeIntensity=0;
let feverGauge=0;
let feverFrames=0;

// ====== 表示フィット ======
const DPR_CAP = 1.25; // 高DPI端末での描画負荷を抑える上限（下げて負荷軽減）
function fit(){
  const d=Math.min(devicePixelRatio||1, DPR_CAP);
  const ar=H/W;
  const safeBottom = (() => {
    const v = getComputedStyle(document.documentElement).getPropertyValue('--safe-bottom');
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : 0;
  })();
  const footerReserved = 80 + safeBottom; // 広告+余白ぶん確保
  const availableHeight = Math.max(120, innerHeight - footerReserved);
  const maxHeight = availableHeight * 0.98;
  const maxWidthFromHeight = maxHeight / ar;
  const maxWidth = innerWidth * 0.98;
  const w=Math.min(maxWidth, maxWidthFromHeight)|0;
  const h=(w*ar)|0;
  c.style.width=w+'px'; c.style.height=h+'px';
  c.width=(w*d)|0; c.height=(h*d)|0;
  x.setTransform((w*d)/W,0,0,(h*d)/H,0,0);
  x.imageSmoothingEnabled=false;
}
addEventListener('resize', fit); fit();

// ====== 生成 ======
function rnd(a,b){return Math.random()*(b-a)+a}
function createEnemyFromType(type, spawnX){
  const sizeMult = type.sizeMult || 1;
  const w = 16 * sizeMult;
  const h = 16 * sizeMult;
  const clampedX = Math.max(0, Math.min(W - w, spawnX));
  return {
    x: clampedX,
    y: -18,
    w,
    h,
    v: type.speed,
    vx: type.zigzag ? ((Math.random() < 0.5 ? -1 : 1) * (type.hSpeed || 0)) : 0,
    baseSpeed: type.speed,
    name: type.name || '',
    sticky: Boolean(type.sticky),
    clearOnShieldHit: Boolean(type.clearOnShieldHit),
    ignoreShield: Boolean(type.ignoreShield),
    followPlayer: Boolean(type.followPlayer),
    followStrength: type.followStrength || 0,
    zigzag: Boolean(type.zigzag),
    absorbed: 0,
    skin: type.skin
  };
}
function spawnEnemy(){
  const elapsedSec = elapsedFrames / 60;
  const candidates = ENEMY_TYPES.filter(t=>elapsedSec >= t.unlockSec);
  const type = candidates[(Math.random()*candidates.length)|0];
  const sizeMult = type.sizeMult || 1;
  const w = 16 * sizeMult;
  E.push(createEnemyFromType(type, rnd(0, W - w)));
}
function spawnAngel(){
  angels.push({x:rnd(0,W-16),y:-18,w:16,h:16,v:1.4,skin:ANGEL});
}

// ====== Angelin 出現頻度（10秒ごと判定 + 30秒保証） ======
const ANGEL_BASE_INTERVAL = 600; // 約10秒ごと
const ANGEL_SPAWN_PROB    = 0.10;
const ANGEL_GUARANTEE_INTERVAL_SEC = 30;
let lastAngelGuaranteeSec = 0;

// ====== 難易度プリセット ======
const DIFFICULTY_PRESETS = {
  easy:   { key:'easy',   label:'簡単',     initialSpawnIntervalFrames:36, minSpawnIntervalFrames:20, maxEnemiesPerSpawn:3, startShieldCharges:1, maxDifficultyLevel:10 },
  normal: { key:'normal', label:'普通',     initialSpawnIntervalFrames:26, minSpawnIntervalFrames:14, maxEnemiesPerSpawn:4, startShieldCharges:0, maxDifficultyLevel:10 },
  endless:{ key:'endless',label:'エンドレス', initialSpawnIntervalFrames:20, minSpawnIntervalFrames:8,  maxEnemiesPerSpawn:6, startShieldCharges:0, maxDifficultyLevel:Infinity }
};
const DIFFICULTY_STORAGE_KEY = 'maoitu_difficulty';

// ====== 難易度スケーリング（時間ベース） ======
const SPAWN_INTERVAL_DECREASE = 1;
const SLOW_DECREASE_THRESHOLD_FRAMES = 15;

let initialSpawnIntervalFrames = DIFFICULTY_PRESETS.endless.initialSpawnIntervalFrames;
let minSpawnIntervalFrames = DIFFICULTY_PRESETS.endless.minSpawnIntervalFrames;
let maxEnemiesPerSpawn = DIFFICULTY_PRESETS.endless.maxEnemiesPerSpawn;
let startShieldCharges = DIFFICULTY_PRESETS.endless.startShieldCharges;
let maxDifficultyLevel = DIFFICULTY_PRESETS.endless.maxDifficultyLevel;
let enemySpawnIntervalFrames = initialSpawnIntervalFrames;
let enemiesPerSpawn = 1;
let difficultyLevel = 1;
const DIFFICULTY_STEP_SEC = 10;
let lastDifficultyUpdateSec = 0;
let elapsedFrames = 0;
let slowDecreaseToggle = false;
let difficultyLabel = DIFFICULTY_PRESETS.endless.label;

const heroShieldIcon = new Image();
heroShieldIcon.src = './assets/kago.png';

function readDifficulty(){
  const params = new URLSearchParams(location.search);
  const q = params.get('mode');
  const stored = lsGet(DIFFICULTY_STORAGE_KEY);
  if(q && DIFFICULTY_PRESETS[q]) return q;
  if(stored && DIFFICULTY_PRESETS[stored]) return stored;
  return 'endless';
}

function applyDifficultyPreset(key){
  const preset = DIFFICULTY_PRESETS[key] || DIFFICULTY_PRESETS.endless;
  initialSpawnIntervalFrames = preset.initialSpawnIntervalFrames;
  minSpawnIntervalFrames = preset.minSpawnIntervalFrames;
  maxEnemiesPerSpawn = preset.maxEnemiesPerSpawn;
  startShieldCharges = preset.startShieldCharges || 0;
  maxDifficultyLevel = preset.maxDifficultyLevel || Infinity;
  difficultyLabel = preset.label;
  lsSet(DIFFICULTY_STORAGE_KEY, preset.key);
}

function nextDifficultyKey(current){
  if(current === 'easy') return 'normal';
  if(current === 'normal') return 'endless';
  return 'endless';
}

const difficultyKey = readDifficulty();
applyDifficultyPreset(difficultyKey);

function triggerHitstop(frames=8, intensity=2){
  hitstopFrames = Math.max(hitstopFrames, frames);
  shakeFrames = Math.max(shakeFrames, frames + 4);
  shakeIntensity = Math.max(shakeIntensity, intensity);
}

function startFever(){
  feverFrames = FEVER_DURATION_FRAMES;
  feverGauge = 0;
  triggerHitstop(4, 1.2);
}

// ====== 楕円ベースのゆるい当たり判定 ======
function hitBox(a, b){
  function ellipse(o, fx=0.8, fy=0.6){
    const rx = o.w * fx / 2;
    const ry = o.h * fy / 2;
    return {
      cx: o.x + o.w / 2,
      cy: o.y + o.h / 2,
      rx,
      ry
    };
  }
  const ea = ellipse(a, 0.8, 0.6);
  const eb = ellipse(b, 0.8, 0.6);
  const dx = ea.cx - eb.cx;
  const dy = ea.cy - eb.cy;
  const rx = ea.rx + eb.rx;
  const ry = ea.ry + eb.ry;
  if(rx === 0 || ry === 0) return false;
  return (dx * dx) / (rx * rx) + (dy * dy) / (ry * ry) <= 1;
}

function rectsOverlap(a, b){
  return !(
    a.x + a.w < b.x ||
    b.x + b.w < a.x ||
    a.y + a.h < b.y ||
    b.y + b.h < a.y
  );
}

// ====== 入力 ======
function pos(e){const r=c.getBoundingClientRect();return (e.clientX-r.left)/r.width*W}
document.onpointerdown = e => {
  if(isOnSharePanel(e.target)) return;
  if(isOnInstructionUi(e.target)) return;
  if(e.cancelable) e.preventDefault();
  if(!alive) return;
  tx = pos(e) - P.w/2;
};
document.onpointermove = e => {
  if(isOnSharePanel(e.target)) return;
  if(isOnInstructionUi(e.target)) return;
  if(e.cancelable) e.preventDefault();
  if(!alive) return;
  tx = pos(e) - P.w/2;
};
addEventListener('keydown',e=>{ if(!alive) return; if(e.key==='ArrowLeft')tx-=20; else if(e.key==='ArrowRight')tx+=20; });

function reset(countPlay = true){ alive=true; E.length=0; angels.length=0; o=0; S=0; shieldCharges=startShieldCharges||0; P.x=PLAYER_START_X; P.y=PLAYER_START_Y; tx=PLAYER_START_TX; P.skin=PLAYER;
  hitstopFrames = 0;
  shieldFlashFrames = 0;
  shakeFrames = 0;
  shakeIntensity = 0;
  feverGauge = 0;
  feverFrames = 0;
  enemySpawnIntervalFrames = initialSpawnIntervalFrames;
  enemiesPerSpawn = 1;
  lastDifficultyUpdateSec = 0;
  elapsedFrames = 0;
  difficultyLevel = 1;
  slowDecreaseToggle = false;
  starOffset = 0;
  starOffsetNear = 0;
  lastAngelGuaranteeSec = 0;
  runCleared = false;
  hideSharePanel();
  hideBackLink();
  if(countPlay) logPlayStart();
}

function endRun(){
  if(!alive) return;
  alive = false;
  showBackLink();
  logPlayEvent('game_over', { score: S });
}

function clearRun(){
  if(!alive) return;
  alive = false;
  runCleared = true;
  showBackLink();
  logPlayEvent('game_clear', { score: S, difficulty: difficultyLabel });
   // クリア時もパネルを即表示
  showSharePanel(S);
}

// ====== 1フレーム ======
function step(){
  if(tutorialActive){
    if(tutorialOverlay && tutorialOverlay.hidden){
      // もし何らかの理由でオーバーレイが見えない場合は進行を止めない
      tutorialActive = false;
    }else{
      return;
    }
  }
  if(hitstopFrames > 0){
    hitstopFrames--;
    return;
  }
  if(o % enemySpawnIntervalFrames === 0){
    for(let i=0;i<enemiesPerSpawn;i++) spawnEnemy();
  }
  if(o % ANGEL_BASE_INTERVAL === 0 && Math.random() < ANGEL_SPAWN_PROB) spawnAngel();
  o++;
  elapsedFrames++;
  const currentSec = elapsedFrames / 60;
  if(currentSec - lastAngelGuaranteeSec >= ANGEL_GUARANTEE_INTERVAL_SEC){
    spawnAngel();
    lastAngelGuaranteeSec = currentSec;
  }

  const speedScale = feverFrames > 0 ? FEVER_SPEED_SCALE : 1;
  const playerSpeed = feverFrames > 0 ? P.v * FEVER_PLAYER_SPEED_MULT : P.v;

  E.forEach(e=>{
    if (e.followPlayer) {
      const dx = (P.x - e.x);
      const step = Math.sign(dx) * Math.min(Math.abs(dx), e.followStrength * speedScale);
      e.x += step;
      e.x = Math.max(0, Math.min(W - e.w, e.x));
    }
    if (e.zigzag && e.vx){
      e.x += e.vx * speedScale;
      if (e.x <= 0){
        e.x = 0;
        e.vx = Math.abs(e.vx);
      }else if (e.x + e.w >= W){
        e.x = W - e.w;
        e.vx = -Math.abs(e.vx);
      }
    }
    e.y+=e.v * speedScale;
  });
  angels.forEach(a=>a.y+=a.v * speedScale);

  const dx=tx-P.x; P.x+=Math.sign(dx)*Math.min(Math.abs(dx),playerSpeed);
  P.x=Math.max(0,Math.min(W-P.w,P.x));

  angels = angels.filter(a=>{
    if(hitBox(P,a)){
      shieldCharges += 1;
      P.skin = ANGEL;
      shieldFlashFrames = SHIELD_FLASH_FRAMES;
      feverGauge = Math.min(FEVER_THRESHOLD_FRAMES, feverGauge + FEVER_GAUGE_BOOST_ON_PICKUP);
      return false;
    }
    return a.y<H+20;
  });

  for (let i = 0; i < E.length; i++) {
    const stickyEnemy = E[i];
    if (!stickyEnemy.sticky) continue;
    for (let j = E.length - 1; j >= 0; j--) {
      if (i === j) continue;
      const target = E[j];
      if (!rectsOverlap(stickyEnemy, target)) continue;
      stickyEnemy.v += target.v * 0.2;
      const newW = stickyEnemy.w * 1.05;
      const newH = stickyEnemy.h * 1.05;
      const deltaW = newW - stickyEnemy.w;
      const deltaH = newH - stickyEnemy.h;
      stickyEnemy.x -= deltaW / 2;
      stickyEnemy.y -= deltaH / 2;
      stickyEnemy.w = newW;
      stickyEnemy.h = newH;
      stickyEnemy.x = Math.max(0, Math.min(W - stickyEnemy.w, stickyEnemy.x));
      stickyEnemy.y = Math.max(-40, Math.min(H, stickyEnemy.y));
      stickyEnemy.absorbed = (stickyEnemy.absorbed || 0) + 1;
      E.splice(j, 1);
      if (j < i) {
        i--;
      }
    }
  }

  for(const e of E){
    if(hitBox(P,e)){
      if (e.ignoreShield) {
        triggerHitstop(HITSTOP_ON_FATAL_FRAMES, SHAKE_INTENSITY_FATAL);
        endRun();
        break;
      }
      if (feverFrames > 0){
        feverFrames = Math.min(FEVER_DURATION_FRAMES, feverFrames + FEVER_HIT_BONUS_FRAMES);
        e.y = H + 99; // 無敵中は敵を消す
        continue;
      }
      if(shieldCharges > 0){
        triggerHitstop(HITSTOP_ON_SHIELD_FRAMES, SHAKE_INTENSITY_SHIELD);
        shieldFlashFrames = SHIELD_FLASH_FRAMES;
        if (e.clearOnShieldHit) {
          shieldCharges = 0; // シールドを全消費
          P.skin = PLAYER;
        } else {
          shieldCharges -= 1;
          if (shieldCharges <= 0){
            shieldCharges = 0;
            P.skin = PLAYER;
          }
        }
        e.y=H+99;
      }else{
        triggerHitstop(HITSTOP_ON_FATAL_FRAMES, SHAKE_INTENSITY_FATAL);
        endRun();
        break;
      }
    }
  }
  E=E.filter(e=>e.y<H+20);
  if(feverFrames > 0){
    feverFrames--;
  }else{
    feverGauge = Math.min(FEVER_THRESHOLD_FRAMES, feverGauge + 1);
    if(feverGauge >= FEVER_THRESHOLD_FRAMES){
      startFever();
    }
  }
  const scoreGain = feverFrames > 0 ? FEVER_SCORE_MULT : 1;
  S+=scoreGain;
  starOffset = (starOffset + STAR_SCROLL_SPEED * speedScale);
  starOffsetNear = (starOffsetNear + STAR_SCROLL_SPEED_NEAR * speedScale);

  if(!alive && sharePanel.style.display==='none'){
    showSharePanel(S);
  }

  const elapsedSec = elapsedFrames / 60;
  if(elapsedSec - lastDifficultyUpdateSec >= DIFFICULTY_STEP_SEC){
    lastDifficultyUpdateSec += DIFFICULTY_STEP_SEC;
    difficultyLevel++;
    if(enemySpawnIntervalFrames > minSpawnIntervalFrames){
      if(enemySpawnIntervalFrames > SLOW_DECREASE_THRESHOLD_FRAMES){
        enemySpawnIntervalFrames = Math.max(SLOW_DECREASE_THRESHOLD_FRAMES, enemySpawnIntervalFrames - SPAWN_INTERVAL_DECREASE);
        if(enemySpawnIntervalFrames <= SLOW_DECREASE_THRESHOLD_FRAMES){
          slowDecreaseToggle = false; // 閾値以下に入った最初のステップは一度スキップする
        }
      }else{
        if(slowDecreaseToggle){
          enemySpawnIntervalFrames = Math.max(minSpawnIntervalFrames, enemySpawnIntervalFrames - SPAWN_INTERVAL_DECREASE);
        }
        slowDecreaseToggle = !slowDecreaseToggle;
      }
    }else{
      enemiesPerSpawn = Math.min(enemiesPerSpawn + 1, maxEnemiesPerSpawn);
    }
    if(difficultyLevel >= maxDifficultyLevel){
      difficultyLevel = maxDifficultyLevel;
      clearRun();
      return;
    }
  }
}
// ====== 描画 ======
function draw(){
  x.save();
  if(shakeFrames > 0){
    const shakePower = (shakeFrames / (shakeFrames + 6)) * shakeIntensity;
    const dx = (Math.random() * 2 - 1) * shakePower;
    const dy = (Math.random() * 2 - 1) * shakePower;
    x.translate(dx, dy);
    shakeFrames--;
  }
  x.drawImage(BG_LAYER,0,0,W,H);
  const offset = starOffset % H;
  x.drawImage(STAR_LAYER,0,offset - H,W,H);
  x.drawImage(STAR_LAYER,0,offset,W,H);
  const offsetNear = starOffsetNear % H;
  x.drawImage(STAR_LAYER_NEAR,0,offsetNear - H,W,H);
  x.drawImage(STAR_LAYER_NEAR,0,offsetNear,W,H);
  if(feverFrames > 0){
    const pulse = 0.08 + 0.06 * Math.sin(elapsedFrames * 0.3);
    x.fillStyle = `rgba(255,200,90,${0.12 + pulse})`;
    x.fillRect(0,0,W,H);
  }
  E.forEach(e=>{
    if(e.ignoreShield){
      const pulse = ((Math.sin(elapsedFrames * 0.25) + 1) * 0.3) + 0.3; // 0.3〜0.9
      const cx = e.x + e.w * 0.5;
      const cy = e.y + e.h * 0.5;
      const radius = Math.max(e.w, e.h) * 0.5 + 6;
      const grad = x.createRadialGradient(cx, cy, radius * 0.25, cx, cy, radius);
      grad.addColorStop(0, `rgba(255,70,70,${pulse})`);
      grad.addColorStop(1, 'rgba(255,70,70,0)');
      x.fillStyle = grad;
      x.beginPath();
      x.arc(cx, cy, radius, 0, Math.PI * 2);
      x.fill();
    }
    if(e.skin.img.complete){
      x.drawImage(e.skin.img,e.x,e.y,e.w,e.h);
    }else{
      x.fillStyle='#f33'; x.fillRect(e.x,e.y,e.w,e.h);
    }
  });
  angels.forEach(a=>{
    const pulse = ((Math.sin(elapsedFrames * 0.2) + 1) * 0.25) + 0.35; // 0.35〜0.85
    const cx = a.x + a.w * 0.5;
    const cy = a.y + a.h * 0.5;
    const radius = Math.max(a.w, a.h) * 0.5 + 6;
    const grad = x.createRadialGradient(cx, cy, radius * 0.3, cx, cy, radius);
    grad.addColorStop(0, `rgba(16,255,180,${pulse})`);
    grad.addColorStop(1, 'rgba(16,255,180,0)');
    x.fillStyle = grad;
    x.beginPath();
    x.arc(cx, cy, radius, 0, Math.PI * 2);
    x.fill();
    if(a.skin.img.complete){
      x.drawImage(a.skin.img,a.x,a.y,a.w,a.h);
    }else{
      x.fillStyle='#fff'; x.fillRect(a.x,a.y,a.w,a.h);
    }
  });
  if(P.skin.img.complete) x.drawImage(P.skin.img,P.x,P.y,P.w,P.h); else { x.fillStyle='#0ff'; x.fillRect(P.x,P.y,P.w,P.h); }
  if(shieldFlashFrames > 0){
    const t = shieldFlashFrames / SHIELD_FLASH_FRAMES;
    const cx = P.x + P.w * 0.5;
    const cy = P.y + P.h * 0.5;
    const radius = 32 + (1 - t) * 10;
    const grad = x.createRadialGradient(cx, cy, P.w * 0.4, cx, cy, radius);
    grad.addColorStop(0, `rgba(200,255,255,${0.45 * t})`);
    grad.addColorStop(1, 'rgba(200,255,255,0)');
    x.fillStyle = grad;
    x.beginPath();
    x.arc(cx, cy, radius, 0, Math.PI*2);
    x.fill();
    shieldFlashFrames--;
  }

  x.fillStyle='#fff';
  x.font='bold 16px monospace';
  x.fillText('S:'+S,4,16);
  x.font='10px monospace';
  const iconSize = 12;
  const iconBaseX = 4;
  const iconBaseY = 24;
  const iconSpacing = iconSize + 2;
  if (heroShieldIcon && heroShieldIcon.complete) {
    if (shieldCharges <= 4) {
      if (shieldCharges === 0) {
        x.save();
        x.globalAlpha = 0.35;
        x.drawImage(heroShieldIcon, iconBaseX, iconBaseY, iconSize, iconSize);
        x.restore();
      } else {
        for (let i = 0; i < shieldCharges; i++) {
          x.drawImage(heroShieldIcon, iconBaseX + iconSpacing * i, iconBaseY, iconSize, iconSize);
        }
      }
    } else {
      for (let i = 0; i < 4; i++) {
        x.drawImage(heroShieldIcon, iconBaseX + iconSpacing * i, iconBaseY, iconSize, iconSize);
      }
      x.fillText('×' + shieldCharges, iconBaseX + iconSpacing * 4 + 2, iconBaseY + iconSize - 2);
    }
  } else {
    x.fillText(shieldCharges ? ('×' + shieldCharges) : '', iconBaseX, iconBaseY + iconSize);
  }
  const feverRatio = feverFrames > 0
    ? Math.max(0, feverFrames / FEVER_DURATION_FRAMES)
    : feverGauge / FEVER_THRESHOLD_FRAMES;
  const barW = 86;
  const barH = 6;
  const barX = W - barW - 6;
  const barY = iconBaseY + 10;
  x.fillStyle = 'rgba(255,255,255,0.18)';
  x.fillRect(barX, barY, barW, barH);
  x.fillStyle = feverFrames > 0 ? 'rgba(250,204,21,0.95)' : 'rgba(125,211,252,0.95)';
  x.fillRect(barX, barY, barW * feverRatio, barH);
  x.fillStyle = '#fff';
  x.fillText(feverFrames > 0 ? 'FEVER x2' : 'FEVER', barX, barY - 2);
  x.fillText('難易度: '+difficultyLevel,4,iconBaseY + 24);
  x.save();
  x.textAlign = 'right';
  x.fillText('モード: '+difficultyLabel,W-4,12);
  x.restore();

  if(!alive){
    // キャンバス上ではパネルを描かず、HTML側のUIに委ねる
  }
  x.restore();
}

// ====== ループ（固定タイムステップ 60Hz） ======
const FIXED_DT_MS = 1000/60;
let last = performance.now();
let acc  = 0;

function loop(now){
  let dt = now - last;
  last = now;
  if (dt > 1000) dt = 1000;
  acc += dt;

  const MAX_STEPS = 5;
  let steps = 0;
  while (acc >= FIXED_DT_MS && steps < MAX_STEPS){
    if (alive && !tutorialActive) step();
    acc -= FIXED_DT_MS;
    steps++;
  }

  draw();
  requestAnimationFrame(loop);
}
reset();
requestAnimationFrame(loop);

</script>
</body>
</html>
