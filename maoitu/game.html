<!DOCTYPE html>

<html lang="ja">
<head>
<meta content="https://pixieed.jp/maoitu/ogp.png" property="og:image"/>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" name="viewport"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<meta content="まおいつ" name="apple-mobile-web-app-title"/>
<title>魔王様！！いつまでよければいいですか！？</title>
<meta content="#000000" name="theme-color"/>

<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SZPVXMX85G"></script>
<script>
const GA_MEASUREMENT_ID = 'G-SZPVXMX85G';
const GA_ADDITIONAL_IDS = ['G-LLSD5KLJVN'];
const GA_PAGE_PATH = '/maoitu/game';
const PROJECT_SLUG = 'maoitu';
const PROJECT_NAME = '魔王様!!いつまでよければいいですか!?';
const PROJECT_TYPE = 'game';
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', GA_MEASUREMENT_ID, {
  page_path: GA_PAGE_PATH,
  page_title: document.title
});
GA_ADDITIONAL_IDS.forEach(id => {
  gtag('config', id, {
    page_path: GA_PAGE_PATH,
    page_title: document.title
  });
});
gtag('event', 'project_open', {
  project_slug: PROJECT_SLUG,
  project_type: PROJECT_TYPE,
  project_name: PROJECT_NAME
});
gtag('event', 'project_open_maoitu');
</script>
<!-- Google AdSense -->
<script async="" crossorigin="anonymous" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9801602250480253"></script>
<style>
  :root{
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  html,body{
    margin:0;
    background:#000;
    height:100%;
    display:grid;
    place-items:center;
    touch-action:none;
    overscroll-behavior:none;
  }
  body{position:relative;}
  #c{display:block;touch-action:none;image-rendering:pixelated}
  .back-link{
    position:absolute;
    top:calc(var(--safe-top) + 18px);
    left:18px;
    padding:8px 14px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.35);
    background:rgba(0,0,0,0.65);
    color:#fff;
    font:600 13px/1.2 system-ui;
    text-decoration:none;
    display:none;
    z-index:40;
    transition:background 0.2s ease,color 0.2s ease,transform 0.2s ease;
  }
  .back-link:hover,
  .back-link:focus-visible{
    background:#fff;
    color:#000;
    transform:translateY(-1px);
    outline:none;
  }
  #gameOverUi{
    position:fixed;
    inset:0;
    display:none;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    padding:calc(var(--safe-top) + 20px) 16px calc(var(--safe-bottom) + 20px);
    gap:18px;
    z-index:20;
    box-sizing:border-box;
    max-height:100%;
    overflow:hidden;
  }
  #gameOverPanel{
    width:min(90vw, 336px);
    padding:14px 16px;
    background:rgba(0,0,0,0.85);
    border:1px solid rgba(255,255,255,0.25);
    border-radius:12px;
    color:#fff;
    text-align:center;
    font-family:sans-serif;
    box-sizing:border-box;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .gameover-title{
    font-size:16px;
    font-weight:700;
    letter-spacing:0.06em;
  }
  #sharePanel{
    display:none;
    flex-direction:column;
    gap:10px;
    padding:12px 16px;
    text-align:center;
    background:rgba(0,0,0,0.8);
    border:1px solid rgba(255,255,255,0.25);
    border-radius:12px;
    color:#fff;
    font-family:sans-serif;
    font-size:12px;
    align-items:stretch;
    width:min(90vw, 336px);
    box-sizing:border-box;
  }
  #sharePanel button{
    font:700 12px system-ui;
    padding:10px 16px;
    border:0;
    border-radius:10px;
    cursor:pointer;
    width:100%;
  }
  #shareScoreLabel{font-size:16px;font-weight:700;text-align:center;}
  #footer{
    position:absolute;
    bottom:calc(var(--safe-bottom) + 12px);
    right:14px;
    color:rgba(255,255,255,0.6);
    font:10px/1.2 monospace;
    user-select:none;
    pointer-events:none;
  }
  #instructions{
    position:absolute;
    top:calc(var(--safe-top) + 20px);
    right:20px;
    max-width:240px;
    padding:18px 16px 16px;
    background:rgba(0,0,0,0.7);
    border:1px solid rgba(255,255,255,0.2);
    border-radius:12px;
    color:#fff;
    font:12px/1.4 system-ui;
    pointer-events:auto;
    user-select:none;
    z-index:5;
    display:none;
  }
  #instructions strong{display:block;font-size:13px;margin-bottom:6px;}
  #instructions p{margin:0 0 6px;}
  #instructions p:last-child{margin-bottom:0;}
  #instructionsClose{
    position:absolute;
    top:6px;
    right:6px;
    width:26px;
    height:26px;
    padding:0;
    border:1px solid rgba(255,255,255,0.3);
    border-radius:999px;
    background:rgba(0,0,0,0.5);
    color:#fff;
    font:13px/1 system-ui;
    cursor:pointer;
  }
  #instructionsToggle{
    position:absolute;
    top:calc(var(--safe-top) + 20px);
    right:20px;
    display:block;
    padding:8px 12px;
    background:rgba(0,0,0,0.7);
    border:1px solid rgba(255,255,255,0.3);
    border-radius:999px;
    color:#fff;
    font:14px/1 system-ui;
    cursor:pointer;
    z-index:5;
  }
</style>
<link href="../character-dots/mao1.png" rel="icon" type="image/png"/></head>
<body>
<a class="back-link" href="./index.html" id="backLink">← スタート画面に戻る</a>
<audio autoplay="" hidden="" id="bgm" loop="" src="bgm.mp3" volume="0.5"></audio>
<canvas id="c"></canvas>
<div id="instructions">
<button id="instructionsClose" type="button">X</button>
<strong>遊び方</strong>
<p>操作方法：画面をタップ / マウスでドラッグ、または ←→ キーで移動。</p>
<p>敵にぶつかると即ゲームオーバー。</p>
<p>エンジェリンに触れると一度だけ身代わりが発動し、次の衝突を防ぎます。</p>
</div>
<button id="instructionsToggle" type="button">?</button>
<div id="gameOverUi">
<div id="gameOverPanel">
<div class="gameover-title">GAME OVER</div>
<div id="shareScoreLabel">SCORE: 0</div>
</div>
<div id="sharePanel">
<button id="shareActionBtn" style="background:#22c55e;color:#000;">シェアする</button>
<button id="restartActionBtn" style="background:#3b82f6;color:#fff;">もう一度遊ぶ</button>
</div>
</div>
<div id="footer">© 2025 アルタ</div>
<script>
// Prevent pinch-zoom on iOS to keep the layout stable.
['gesturestart', 'gesturechange', 'gestureend'].forEach((eventName) => {
  document.addEventListener(eventName, (event) => {
    event.preventDefault();
  }, { passive: false });
});

document.addEventListener('touchmove', (event) => {
  if(event.touches.length > 1){
    event.preventDefault();
  }
}, { passive: false });

const bgm = document.getElementById('bgm');
bgm.volume = 0.5;
const AUDIO_KEY = 'maoitu_audio';
const GAME_CANONICAL_URL = `${window.location.origin}/maoitu/`;
function syncAudioSetting(){
  const enabled = localStorage.getItem(AUDIO_KEY) !== 'off';
  bgm.muted = !enabled;
  if(!enabled && !bgm.paused) bgm.pause();
  return enabled;
}
let audioEnabled = syncAudioSetting();
const gameOverUi = document.getElementById('gameOverUi');
const sharePanel = document.getElementById('sharePanel');
const shareScoreLabel = document.getElementById('shareScoreLabel');
const shareActionBtn = document.getElementById('shareActionBtn');
const restartActionBtn = document.getElementById('restartActionBtn');
const instructions = document.getElementById('instructions');
const instructionsCloseBtn = document.getElementById('instructionsClose');
const instructionsToggleBtn = document.getElementById('instructionsToggle');
const backLink = document.getElementById('backLink');
let shareScore = 0;

function openInstructions(){
  instructions.style.display = 'block';
  instructionsToggleBtn.style.display = 'none';
}

function closeInstructions(){
  instructions.style.display = 'none';
  instructionsToggleBtn.style.display = 'block';
}

function logPlayEvent(eventName, params={}){
  if(typeof window.gtag === 'function' && GA_MEASUREMENT_ID){
    window.gtag('event', eventName, params);
  }
}

function logPlayStart(){
  logPlayEvent('play_started');
}

function shareText(score){
  return `開発者:@PiXiEED_arta\n『魔王様！！いつまでよければいいですか！？』\nスコア: ${score}\n皆もやってみてね！！！\n\nリンクから遊べるよ！！#PiXiEED\n\n${GAME_CANONICAL_URL}`;
}

async function copyShareText(text){
  try{
    await navigator.clipboard.writeText(text);
    alert('シェア用テキストをコピーしました！');
  }catch(err){
    alert('シェア機能が利用できません。手動でスコアを共有してください。');
  }
}

shareActionBtn.addEventListener('click', async () => {
  const text = shareText(shareScore);
  copyShareText(text);
});

restartActionBtn.addEventListener('click', () => {
  hideSharePanel();
  reset();
});

instructionsCloseBtn.addEventListener('click', () => {
  closeInstructions();
});

instructionsToggleBtn.addEventListener('click', () => {
  openInstructions();
});

function showBackLink(){
  backLink.style.display = 'inline-flex';
}

function hideBackLink(){
  backLink.style.display = 'none';
}

function showSharePanel(score){
  shareScore = score;
  shareScoreLabel.textContent = `SCORE: ${score}`;
  gameOverUi.style.display = 'flex';
  sharePanel.style.display = 'flex';
  if(typeof restartActionBtn.focus === 'function'){
    try{
      restartActionBtn.focus({ preventScroll: true });
    }catch(_){
      restartActionBtn.focus();
    }
  }
}

function hideSharePanel(){
  sharePanel.style.display = 'none';
  gameOverUi.style.display = 'none';
  closeInstructions();
}
hideSharePanel();
function isOnSharePanel(target){
  return gameOverUi.style.display !== 'none' && gameOverUi.contains(target);
}
function isOnInstructionUi(target){
  if(instructions.style.display !== 'none' && instructions.contains(target)) return true;
  if(instructionsToggleBtn.style.display !== 'none' && instructionsToggleBtn.contains(target)) return true;
  return false;
}
// モバイル環境での自動再生対策
document.addEventListener('click', () => {
  audioEnabled = syncAudioSetting();
  if (audioEnabled && bgm.paused) {
    bgm.play().catch(()=>{});
  }
}, { once: true });
// ====== 画像（Base64） ======
// ====== 敵キャラ（解禁スケジュール付き） ======
const ENEMY_TYPES_DATA=[
  {src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAQRJREFUOI3tkjFLA0EQhb89L8LBHZxFmq3sAoKQTgj4A6yutrT0F6W0s7cKgl2CcF2qgJ0gbJPCg12InCFjIXe5jWsg1k45s9/beY+B/1KBnhzC7AqIyJafORzA3K5TgIWF8aDncSoEzxzu3qxTU23FltUGY1ZcjVJPJArBc+vDAP08QuuEybPj9uWztRp3HzXw01s4hn4eAcmPQGRqxQOX1WaPwHfpXDEe9FoLLCx74d9mEZ2U/1JtBqYSHi6OveHp3TsArzcnXr8oa86yzgbN+qPHDwCmVtzuT02vKGt0rhhmsaNzB1KUdevRmFVwXa0Trs+PGGaxu8xUCijvkA60rwC+AHX1dn623PVvAAAAAElFTkSuQmCC",speed:1.8,unlockSec:0},
  {src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAPlJREFUOI2dU7EOgjAUvFZ+wriQAGFB6wc4+AksfCUO+CcYXYjVzTgykxjqgK+2tGj0kibtpXe9tFcGP9QEz74RCgDqo1+/Xurt7gSAGgtFBuz2rlmRc61lplhkw+JwAs4Xhdu9d8SLObdMAm9WA42cNqEETnQ6vZE9zpeH5pNoOC+NORZzjiLnCMZCAJZYXjvLPIkCNLLXKXQWkQ3CT2J57axElgHd9pTYNPEa/II05kgi9r+B+QoEVVa9ejVRj3DVqnDVOnx9VDS3E5TV8Oa+KhNnFg7jKpPBuANJFCCNObabGUQGMPZusfczkRGBLuzbZ3KMPHD2PwEgq485RM69+AAAAABJRU5ErkJggg==",speed:1.3,unlockSec:5},
  {src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAARNJREFUOI1jZMAO/uMQZyQowMDA8P//f4j+W+sRgvf3/GXwmMaCoYcFl+YT3f8wTO5XeM9Q+EDwP7IhTIRsRga8omwM/QrvGZC9yESsZgYGBgYZU3YMQxjxaX53B+KNjw+wh6nHNBZEGCD7WUiFiWFb0Qe4sxkYGBgEZFkZPjz+jeIauBdw2YxLMzJgwiqKppmBgYHh8+tfxBsA8zNMM48ETnsgYfDuzj+MgII5G9lmZDa/AgeK+v/9Cu//Q6MGjueYfv0/x/QrhvjNdf9hbLgXGAsfCMLil+HmOsxog4ndXPefQT2IkQGWGtHzwv9+hffwAEQHtpVcKJqxGQA3RNOLF0WQX4GRwbKMGUMPNgMYSMnOAMtAf3plqr/eAAAAAElFTkSuQmCC",speed:2.3,unlockSec:15},
  {src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAYBJREFUOI2lU79rwkAYfQkRO2TIcNDRGxxFupR2EFwzNHuH/gn9D3TsnyLY/RxuFHRI6SCImwGzqSRDhoBK1K+Ll56n0qEf3PLuvXffj/ssXA+6gVsm4FwVSuLCA9cvggwxfEsZl0bWmVgSL+7x5jRTP7Xdum7Ajnm0nzJZWaMH34qV1jHF2cP2nUX50MuZlDuMAcCvogV31XCa8IspQ0USP2VTJkDFhDoJbZY0X/RFSO2ENks6JKNiQh0RUluE1Kb5oq8wvU8ESTU6JCNdLEJqQ1JNP7oJJNUAkA0AwgNPbbe+z/ns+Wn7GX7dvQYZYr0HwgMPMsT7nM9S262rJts6Se4wZsc8MsVlH04cHbdN4n7KpImZI71p4FfRMl8QHvjLY/pxNhEtHJw+CUWr4WDHxyp94YEr8uCbdYMMsfDAHTdusKMbBdndWZmkjeb3qAkYuD7GsoTKGr1iQl0ASGizUlmo+hVWTKhbWaOndP/+yuZ2/bVMqu6ry3RpdBkX/B/RH/qbfqrLJgAAAABJRU5ErkJggg==",speed:1.0,unlockSec:25},
  {src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAQZJREFUOI2Nk01OwzAQhb+ReoCyJyAWEXeouuNnBYfpSVhwgFwBiQVRxK7tHUBIQRRxjsdmpnJdOzCSZfnZ74szMzbqoWxtpUOzmlkSwCfwCGBmKkFKAGm9BuiBS9c6SUVIDpC2IywueuAtATQ1SArQdy9YEOYd8O5757WbBECvgzi9OTB/ALe+3yYfOoDMAD3phyuOzF/+C8MfECRplDR66fbD9YeCvpK0ilLvhRAlvcQsaZ5pcx93gNIkdkAj6R5oJQ2RA0knPjfAEtikVTAzi8bpEmDrOYlogGs/szSz50giE5CzKXPeByXILumDI3MOmLrJpmQuAXIInjRKZmpP1ONfz/kX+Gq5jszpIJsAAAAASUVORK5CYII=",speed:2.8,unlockSec:35},
  {src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAZZJREFUOI2FUzFrwkAU/myPpEMI4qSCEIhYiwUHh3S8rdQhP8HY31HEtFC6SceO1qHQrUgRnAzdHKQEWihSMYtb1gy1adPBXryYtH5wy/fe++67d++lkIzgDz61jQgAQHc1s/qhm1f3Zw4L+Lag4HYZq9uNFBsCWoMLSHs5CJ+iIte868BfpI9OtIf945w1yy6U76yQhv1lAjgHgB2+mFSXTiGTdyVPprbYNwGgVNMslVAKAPWG1iXVpQNDCN0Sdj2pLp1iBc6jd2NBTG6ASiitN9Ad9MZNH1CYgwCGgGIFTqmmWSx50Bs3p5MxBQDJk6lKKJU8OXTCXLAngBUzu8UKwgbaYt+UPJkWMnkXAJhw5AkqoXTmW9amIC9ie+vY290z5ZsYszmdjClz8x9CgaTu8+62CnSeTl9YMcPMtyyVUHoglg95nu8BQ0A6mP/+bXh0V2vrrtbe5LnctQAMIQy0FpcBgKA8xKg8xIjnSAdzGAITi+xCOI3Y+EYAeH9dDQ63E6lNAYS2VkMSR8IyxdYzIhRHLP8H/uGrhM0W27cAAAAASUVORK5CYII=",speed:1.2,unlockSec:45,sticky:true}
];
const PLAYER_SRC="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAQRJREFUOI3tkDtOw1AQRY+hQ7iI05CPkFLYRUSNKHARBbEFV6whBRtIFhCldZcNsAtTIJBYgC3hipgGGztBIDePwt+Xj9JSZKSnuXP15s7MhUP8sxhkSQCirV9sxYM9GsIBMbwbCfJcx04uUm84LpHahTQZn5ye83qm0jT6zB7mfLwFfN3eEP8m/Cy+eUljULsT0gQABQDNgNAVXN7D9RU0WtWIKMjqKMjqxyd4noJmKIRuLgBycxTA+6d8XKdZ4UIElKOS7Om7m0HmevqmeVh23SRRcFi2xDkFn5tZbeB7mJYNgLMUq/UJBWdaNvheyW+auGU9KXxPMrEKzYD1E3a97C8AfzBBfBZb3sdTAAAAAElFTkSuQmCC";
const ANGEL_SRC="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAARZJREFUOI2lkz1OxDAQRt9YCAGSG0REg5ZqC67ABTgB0jZ0ewMqTkC1N6CjQeIEcACuQJGKFRJCRttYWtA2Q+FMsk4C4eer7PE8zzcZB/4pAbS1N2lPbudMANWHSxhvIsV5E7u5yunJtDkLMyhXyPEFDoB5AeUKDbPm9lFAJtMEjkJd2WDmRWZLAdadVJc1DixWVbawkKvd91eSzgLQa73jgCeOgP23mBGve55H4JlDzuSkZusWVH9a3Lwn3gF6//I7GKBi1AEsw2B+R8Y4gK04kN0jYxyA/4MDYzYAxj5tpDVV+7B9cWOSg0UOtB/ResxyjKnH+H6rxF0oI8QCPjzspNfKMqSefUhu/QK2T9MYv/v7hiQAn7kqbU+zGAhDAAAAAElFTkSuQmCC";

// ====== 画像読み込み & アルファマップ ======
function withAlpha(src){
  const img=new Image(); img.src=src;
  const out={img,ready:false,alpha:null};
  img.onload=()=>{
    const oc=document.createElement('canvas'); oc.width=16; oc.height=16;
    const ctx=oc.getContext('2d'); ctx.drawImage(img,0,0,16,16);
    out.alpha=ctx.getImageData(0,0,16,16).data; out.ready=true;
  };
  return out;
}
const ENEMY_TYPES=ENEMY_TYPES_DATA.map(t=>({...t,skin:withAlpha(t.src)}));
const PLAYER=withAlpha(PLAYER_SRC);
const ANGEL=withAlpha(ANGEL_SRC);
const PLAYER_START_X = 72;
const PLAYER_START_Y = 180;
const PLAYER_START_TX = 80;

// ====== 基本設定 ======
let c=document.getElementById('c'),x=c.getContext('2d',{alpha:false}),W=160,H=240;
let P={x:PLAYER_START_X,y:PLAYER_START_Y,w:16,h:16,v:4,skin:PLAYER};
let E=[], angels=[], o=0, tx=PLAYER_START_TX, S=0, alive=true, shieldCharges=0;

// ====== 表示フィット ======
function fit(){
  const d=devicePixelRatio||1, ar=H/W;
  const w=Math.min(innerWidth*.98, innerHeight*.98/ar)|0;
  const h=(w*ar)|0;
  c.style.width=w+'px'; c.style.height=h+'px';
  c.width=(w*d)|0; c.height=(h*d)|0;
  x.setTransform((w*d)/W,0,0,(h*d)/H,0,0);
  x.imageSmoothingEnabled=false;
}
addEventListener('resize', fit); fit();

// ====== 生成 ======
function rnd(a,b){return Math.random()*(b-a)+a}
function spawnEnemy(){
  const elapsedSec = elapsedFrames / 60;
  const candidates = ENEMY_TYPES.filter(t=>elapsedSec >= t.unlockSec);
  const type = candidates[(Math.random()*candidates.length)|0];
  E.push({
    x: rnd(0, W - 16),
    y: -18,
    w: 16,
    h: 16,
    v: type.speed,
    baseSpeed: type.speed,
    sticky: Boolean(type.sticky),
    absorbed: 0,
    skin: type.skin
  });
}
function spawnAngel(){
  angels.push({x:rnd(0,W-16),y:-18,w:16,h:16,v:1.4,skin:ANGEL});
}

// ====== Angelin 出現頻度（5秒ごと判定 + 低確率） ======
const ANGEL_BASE_INTERVAL = 300;
const ANGEL_SPAWN_PROB    = 0.10;

// ====== 難易度スケーリング（時間ベース） ======
const INITIAL_SPAWN_INTERVAL_FRAMES = 20;
const SPAWN_INTERVAL_DECREASE = 1;
const MIN_SPAWN_INTERVAL_FRAMES = 8;
const MAX_ENEMIES_PER_SPAWN = 6;
const SLOW_DECREASE_THRESHOLD_FRAMES = 15;

let enemySpawnIntervalFrames = INITIAL_SPAWN_INTERVAL_FRAMES;
let enemiesPerSpawn = 1;
let difficultyLevel = 1;
const DIFFICULTY_STEP_SEC = 10;
let lastDifficultyUpdateSec = 0;
let elapsedFrames = 0;
let slowDecreaseToggle = false;

const heroShieldIcon = new Image();
heroShieldIcon.src = './assets/kago.png';

// ====== 楕円ベースのゆるい当たり判定 ======
function hitBox(a, b){
  function ellipse(o, fx=0.8, fy=0.6){
    const rx = o.w * fx / 2;
    const ry = o.h * fy / 2;
    return {
      cx: o.x + o.w / 2,
      cy: o.y + o.h / 2,
      rx,
      ry
    };
  }
  const ea = ellipse(a, 0.8, 0.6);
  const eb = ellipse(b, 0.8, 0.6);
  const dx = ea.cx - eb.cx;
  const dy = ea.cy - eb.cy;
  const rx = ea.rx + eb.rx;
  const ry = ea.ry + eb.ry;
  if(rx === 0 || ry === 0) return false;
  return (dx * dx) / (rx * rx) + (dy * dy) / (ry * ry) <= 1;
}

function rectsOverlap(a, b){
  return !(
    a.x + a.w < b.x ||
    b.x + b.w < a.x ||
    a.y + a.h < b.y ||
    b.y + b.h < a.y
  );
}

// ====== 入力 ======
function pos(e){const r=c.getBoundingClientRect();return (e.clientX-r.left)/r.width*W}
document.onpointerdown = e => {
  if(isOnSharePanel(e.target)) return;
  if(isOnInstructionUi(e.target)) return;
  if(e.cancelable) e.preventDefault();
  if(!alive) return;
  tx = pos(e) - P.w/2;
};
document.onpointermove = e => {
  if(isOnSharePanel(e.target)) return;
  if(isOnInstructionUi(e.target)) return;
  if(e.cancelable) e.preventDefault();
  if(!alive) return;
  tx = pos(e) - P.w/2;
};
addEventListener('keydown',e=>{ if(!alive) return; if(e.key==='ArrowLeft')tx-=20; else if(e.key==='ArrowRight')tx+=20; });

function reset(countPlay = true){ alive=true; E.length=0; angels.length=0; o=0; S=0; shieldCharges=0; P.x=PLAYER_START_X; P.y=PLAYER_START_Y; tx=PLAYER_START_TX; P.skin=PLAYER;
  enemySpawnIntervalFrames = INITIAL_SPAWN_INTERVAL_FRAMES;
  enemiesPerSpawn = 1;
  lastDifficultyUpdateSec = 0;
  elapsedFrames = 0;
  difficultyLevel = 1;
  slowDecreaseToggle = false;
  closeInstructions();
  hideSharePanel();
  hideBackLink();
  if(countPlay) logPlayStart();
}

function endRun(){
  if(!alive) return;
  alive = false;
  showBackLink();
  logPlayEvent('game_over', { score: S });
}

// ====== 1フレーム ======
function step(){
  if(o % enemySpawnIntervalFrames === 0){
    for(let i=0;i<enemiesPerSpawn;i++) spawnEnemy();
  }
  if(o % ANGEL_BASE_INTERVAL === 0 && Math.random() < ANGEL_SPAWN_PROB) spawnAngel();
  o++;
  elapsedFrames++;

  E.forEach(e=>e.y+=e.v);
  angels.forEach(a=>a.y+=a.v);

  const dx=tx-P.x; P.x+=Math.sign(dx)*Math.min(Math.abs(dx),P.v);
  P.x=Math.max(0,Math.min(W-P.w,P.x));

  angels = angels.filter(a=>{
    if(hitBox(P,a)){
      shieldCharges += 1;
      P.skin = ANGEL;
      return false;
    }
    return a.y<H+20;
  });

  for (let i = 0; i < E.length; i++) {
    const stickyEnemy = E[i];
    if (!stickyEnemy.sticky) continue;
    for (let j = E.length - 1; j >= 0; j--) {
      if (i === j) continue;
      const target = E[j];
      if (!rectsOverlap(stickyEnemy, target)) continue;
      stickyEnemy.v += target.v * 0.2;
      const newW = stickyEnemy.w * 1.05;
      const newH = stickyEnemy.h * 1.05;
      const deltaW = newW - stickyEnemy.w;
      const deltaH = newH - stickyEnemy.h;
      stickyEnemy.x -= deltaW / 2;
      stickyEnemy.y -= deltaH / 2;
      stickyEnemy.w = newW;
      stickyEnemy.h = newH;
      stickyEnemy.x = Math.max(0, Math.min(W - stickyEnemy.w, stickyEnemy.x));
      stickyEnemy.y = Math.max(-40, Math.min(H, stickyEnemy.y));
      stickyEnemy.absorbed = (stickyEnemy.absorbed || 0) + 1;
      E.splice(j, 1);
      if (j < i) {
        i--;
      }
    }
  }

  for(const e of E){
    if(hitBox(P,e)){
      if(shieldCharges > 0){
        shieldCharges -= 1;
        if (shieldCharges <= 0){
          shieldCharges = 0;
          P.skin = PLAYER;
        }
        e.y=H+99;
      }else{
        endRun();
        break;
      }
    }
  }
  E=E.filter(e=>e.y<H+20);
  S++;

  if(!alive && sharePanel.style.display==='none'){
    showSharePanel(S);
  }

  const elapsedSec = elapsedFrames / 60;
  if(elapsedSec - lastDifficultyUpdateSec >= DIFFICULTY_STEP_SEC){
    lastDifficultyUpdateSec += DIFFICULTY_STEP_SEC;
    difficultyLevel++;
    if(enemySpawnIntervalFrames > MIN_SPAWN_INTERVAL_FRAMES){
      if(enemySpawnIntervalFrames > SLOW_DECREASE_THRESHOLD_FRAMES){
        enemySpawnIntervalFrames = Math.max(SLOW_DECREASE_THRESHOLD_FRAMES, enemySpawnIntervalFrames - SPAWN_INTERVAL_DECREASE);
        if(enemySpawnIntervalFrames <= SLOW_DECREASE_THRESHOLD_FRAMES){
          slowDecreaseToggle = false; // 閾値以下に入った最初のステップは一度スキップする
        }
      }else{
        if(slowDecreaseToggle){
          enemySpawnIntervalFrames = Math.max(MIN_SPAWN_INTERVAL_FRAMES, enemySpawnIntervalFrames - SPAWN_INTERVAL_DECREASE);
        }
        slowDecreaseToggle = !slowDecreaseToggle;
      }
    }else{
      enemiesPerSpawn = Math.min(enemiesPerSpawn + 1, MAX_ENEMIES_PER_SPAWN);
    }
  }
}

// ====== 描画 ======
function draw(){
  x.fillStyle='#000'; x.fillRect(0,0,W,H);
  E.forEach(e=> e.skin.img.complete ? x.drawImage(e.skin.img,e.x,e.y,e.w,e.h) : (x.fillStyle='#f33',x.fillRect(e.x,e.y,e.w,e.h)));
  angels.forEach(a=> a.skin.img.complete ? x.drawImage(a.skin.img,a.x,a.y,a.w,a.h) : (x.fillStyle='#fff',x.fillRect(a.x,a.y,a.w,a.h)));
  if(P.skin.img.complete) x.drawImage(P.skin.img,P.x,P.y,P.w,P.h); else { x.fillStyle='#0ff'; x.fillRect(P.x,P.y,P.w,P.h); }

  x.fillStyle='#fff';
  x.font='bold 16px monospace';
  x.fillText('S:'+S,4,16);
  x.font='10px monospace';
  const iconSize = 12;
  const iconBaseX = 4;
  const iconBaseY = 24;
  const iconSpacing = iconSize + 2;
  if (heroShieldIcon && heroShieldIcon.complete) {
    if (shieldCharges <= 4) {
      if (shieldCharges === 0) {
        x.save();
        x.globalAlpha = 0.35;
        x.drawImage(heroShieldIcon, iconBaseX, iconBaseY, iconSize, iconSize);
        x.restore();
      } else {
        for (let i = 0; i < shieldCharges; i++) {
          x.drawImage(heroShieldIcon, iconBaseX + iconSpacing * i, iconBaseY, iconSize, iconSize);
        }
      }
    } else {
      for (let i = 0; i < 4; i++) {
        x.drawImage(heroShieldIcon, iconBaseX + iconSpacing * i, iconBaseY, iconSize, iconSize);
      }
      x.fillText('×' + shieldCharges, iconBaseX + iconSpacing * 4 + 2, iconBaseY + iconSize - 2);
    }
  } else {
    x.fillText(shieldCharges ? ('×' + shieldCharges) : '', iconBaseX, iconBaseY + iconSize);
  }
  x.fillText('難易度: '+difficultyLevel,4,iconBaseY + 24);

  if(!alive){
    // キャンバス上ではパネルを描かず、HTML側のUIに委ねる
  }
}

// ====== ループ（固定タイムステップ 60Hz） ======
const FIXED_DT_MS = 1000/60;
let last = performance.now();
let acc  = 0;

function loop(now){
  let dt = now - last;
  last = now;
  if (dt > 1000) dt = 1000;
  acc += dt;

  const MAX_STEPS = 5;
  let steps = 0;
  while (acc >= FIXED_DT_MS && steps < MAX_STEPS){
    if (alive) step();
    acc -= FIXED_DT_MS;
    steps++;
  }

  draw();
  requestAnimationFrame(loop);
}
reset();
requestAnimationFrame(loop);

</script>
</body>
</html>
